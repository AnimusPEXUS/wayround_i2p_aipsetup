

<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>org.wayround.aipsetup.package &mdash; aipsetup 3 documentation</title>
    
    <link rel="stylesheet" href="../../../../_static/default.css" type="text/css" />
    <link rel="stylesheet" href="../../../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../../../',
        VERSION:     '3',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../../_static/doctools.js"></script>
    <link rel="top" title="aipsetup 3 documentation" href="../../../../index.html" />
    <link rel="up" title="Module code" href="../../../index.html" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="../../../../index.html">aipsetup 3 documentation</a> &raquo;</li>
          <li><a href="../../../index.html" accesskey="U">Module code</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <h1>Source code for org.wayround.aipsetup.package</h1><div class="highlight"><pre>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Module for GNU/Linux system related package actions</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">copy</span>
<span class="kn">import</span> <span class="nn">fnmatch</span>
<span class="kn">import</span> <span class="nn">functools</span>
<span class="kn">import</span> <span class="nn">glob</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">os.path</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">shutil</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">tarfile</span>
<span class="kn">import</span> <span class="nn">tempfile</span>


<span class="kn">import</span> <span class="nn">org.wayround.utils.archive</span>
<span class="kn">import</span> <span class="nn">org.wayround.utils.checksum</span>
<span class="kn">import</span> <span class="nn">org.wayround.utils.file</span>
<span class="kn">import</span> <span class="nn">org.wayround.utils.format.elf</span>
<span class="kn">import</span> <span class="nn">org.wayround.utils.format.elf_enum</span>
<span class="kn">import</span> <span class="nn">org.wayround.utils.log</span>
<span class="kn">import</span> <span class="nn">org.wayround.utils.opts</span>
<span class="kn">import</span> <span class="nn">org.wayround.utils.path</span>
<span class="kn">import</span> <span class="nn">org.wayround.utils.text</span>
<span class="kn">import</span> <span class="nn">org.wayround.utils.time</span>


<span class="kn">import</span> <span class="nn">org.wayround.aipsetup.build</span>
<span class="kn">import</span> <span class="nn">org.wayround.aipsetup.buildingsite</span>
<span class="kn">import</span> <span class="nn">org.wayround.aipsetup.config</span>
<span class="kn">import</span> <span class="nn">org.wayround.aipsetup.name</span>
<span class="kn">import</span> <span class="nn">org.wayround.aipsetup.pack</span>
<span class="kn">import</span> <span class="nn">org.wayround.aipsetup.pkgindex</span>
<span class="kn">import</span> <span class="nn">org.wayround.aipsetup.pkginfo</span>
<span class="kn">import</span> <span class="nn">org.wayround.aipsetup.sysupdates</span>


<span class="n">ROOT_LINKS</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">sep</span> <span class="o">+</span> <span class="s">&#39;bin&#39;</span><span class="p">,</span>
    <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">sep</span> <span class="o">+</span> <span class="s">&#39;sbin&#39;</span><span class="p">,</span>
    <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">sep</span> <span class="o">+</span> <span class="s">&#39;lib&#39;</span><span class="p">,</span>
    <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">sep</span> <span class="o">+</span> <span class="s">&#39;lib64&#39;</span>
    <span class="p">]</span>

<span class="k">def</span> <span class="nf">cli_name</span><span class="p">():</span>
    <span class="k">return</span> <span class="s">&#39;pkg&#39;</span>
<div class="viewcode-block" id="cli_name"><a class="viewcode-back" href="../../../../package.html#org.wayround.aipsetup.package.cli_name">[docs]</a>

<span class="k">def</span> <span class="nf">exported_commands</span><span class="p">():</span>
    <span class="k">return</span> <span class="p">{</span></div>
<div class="viewcode-block" id="exported_commands"><a class="viewcode-back" href="../../../../package.html#org.wayround.aipsetup.package.exported_commands">[docs]</a>        <span class="s">&#39;check&#39;</span>         <span class="p">:</span> <span class="n">package_check_package</span><span class="p">,</span>
        <span class="s">&#39;install&#39;</span>       <span class="p">:</span> <span class="n">package_install</span><span class="p">,</span>
        <span class="s">&#39;list&#39;</span>          <span class="p">:</span> <span class="n">package_list</span><span class="p">,</span>
        <span class="s">&#39;list_asps&#39;</span>     <span class="p">:</span> <span class="n">package_list_asps</span><span class="p">,</span>
        <span class="s">&#39;remove&#39;</span>        <span class="p">:</span> <span class="n">package_remove</span><span class="p">,</span>
        <span class="s">&#39;complete&#39;</span>      <span class="p">:</span> <span class="n">package_complete</span><span class="p">,</span>
        <span class="s">&#39;build&#39;</span>         <span class="p">:</span> <span class="n">package_build</span><span class="p">,</span>
        <span class="s">&#39;find&#39;</span>          <span class="p">:</span> <span class="n">package_find_files</span>
        <span class="p">}</span>

<span class="k">def</span> <span class="nf">commands_order</span><span class="p">():</span>
    <span class="k">return</span> <span class="p">[</span></div>
<div class="viewcode-block" id="commands_order"><a class="viewcode-back" href="../../../../package.html#org.wayround.aipsetup.package.commands_order">[docs]</a>        <span class="s">&#39;check&#39;</span><span class="p">,</span>
        <span class="s">&#39;list&#39;</span><span class="p">,</span>
        <span class="s">&#39;list_asps&#39;</span><span class="p">,</span>
        <span class="s">&#39;install&#39;</span><span class="p">,</span>
        <span class="s">&#39;remove&#39;</span><span class="p">,</span>
        <span class="s">&#39;complete&#39;</span><span class="p">,</span>
        <span class="s">&#39;build&#39;</span><span class="p">,</span>
        <span class="s">&#39;find&#39;</span>
        <span class="p">]</span>

<span class="k">def</span> <span class="nf">package_install</span><span class="p">(</span><span class="n">opts</span><span class="p">,</span> <span class="n">args</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span></div>
<div class="viewcode-block" id="package_install"><a class="viewcode-back" href="../../../../package.html#org.wayround.aipsetup.package.package_install">[docs]</a><span class="sd">    Install package(s)</span>

<span class="sd">    [-b=DIRNAME] [--force] NAMES</span>

<span class="sd">    If -b is given - it is used as destination root</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">ret</span> <span class="o">=</span> <span class="n">org</span><span class="o">.</span><span class="n">wayround</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">opts</span><span class="o">.</span><span class="n">is_wrong_opts</span><span class="p">(</span>
        <span class="n">opts</span><span class="p">,</span>
        <span class="p">[</span><span class="s">&#39;-b&#39;</span><span class="p">,</span> <span class="s">&#39;--force&#39;</span><span class="p">]</span>
        <span class="p">)</span>

    <span class="k">if</span> <span class="n">ret</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>

        <span class="n">basedir</span> <span class="o">=</span> <span class="s">&#39;/&#39;</span>
        <span class="k">if</span> <span class="s">&#39;-b&#39;</span> <span class="ow">in</span> <span class="n">opts</span><span class="p">:</span>
            <span class="n">basedir</span> <span class="o">=</span> <span class="n">opts</span><span class="p">[</span><span class="s">&#39;-b&#39;</span><span class="p">]</span>

        <span class="n">force</span> <span class="o">=</span> <span class="s">&#39;--force&#39;</span> <span class="ow">in</span> <span class="n">opts</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&quot;Package name(s) required!&quot;</span><span class="p">)</span>
            <span class="n">ret</span> <span class="o">=</span> <span class="mi">2</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">names</span> <span class="o">=</span> <span class="n">args</span>

            <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">names</span><span class="p">:</span>
                <span class="n">ret</span> <span class="o">=</span> <span class="n">install_package</span><span class="p">(</span>
                    <span class="n">name</span><span class="p">,</span> <span class="n">force</span><span class="p">,</span> <span class="n">basedir</span>
                    <span class="p">)</span>
                <span class="k">if</span> <span class="n">ret</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                        <span class="s">&quot;Some package&#39;s installation error -- see above&quot;</span>
                        <span class="p">)</span>
                    <span class="k">break</span>

            <span class="n">org</span><span class="o">.</span><span class="n">wayround</span><span class="o">.</span><span class="n">aipsetup</span><span class="o">.</span><span class="n">sysupdates</span><span class="o">.</span><span class="n">all_actions</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">ret</span>


<span class="k">def</span> <span class="nf">package_list</span><span class="p">(</span><span class="n">opts</span><span class="p">,</span> <span class="n">args</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span></div>
<div class="viewcode-block" id="package_list"><a class="viewcode-back" href="../../../../package.html#org.wayround.aipsetup.package.package_list">[docs]</a><span class="sd">    List installed packages</span>

<span class="sd">    [-b=DIRNAME] MASK</span>

<span class="sd">    -b is same as in install</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="n">basedir</span> <span class="o">=</span> <span class="s">&#39;/&#39;</span>
    <span class="k">if</span> <span class="s">&#39;-b&#39;</span> <span class="ow">in</span> <span class="n">opts</span><span class="p">:</span>
        <span class="n">basedir</span> <span class="o">=</span> <span class="n">opts</span><span class="p">[</span><span class="s">&#39;-b&#39;</span><span class="p">]</span>

    <span class="n">mask</span> <span class="o">=</span> <span class="s">&#39;*&#39;</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">basedir</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&quot;given basedir name is wrong&quot;</span><span class="p">)</span>
        <span class="n">ret</span> <span class="o">=</span> <span class="mi">2</span>

    <span class="k">if</span> <span class="n">ret</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">lst</span> <span class="o">=</span> <span class="n">list_installed_packages</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="n">basedir</span><span class="p">)</span>

        <span class="n">lst</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>

        <span class="n">org</span><span class="o">.</span><span class="n">wayround</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">columned_list_print</span><span class="p">(</span>
            <span class="n">lst</span><span class="p">,</span> <span class="n">fd</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">fileno</span><span class="p">()</span>
        <span class="p">)</span>

    <span class="k">return</span> <span class="n">ret</span>

<span class="k">def</span> <span class="nf">package_list_asps</span><span class="p">(</span><span class="n">opts</span><span class="p">,</span> <span class="n">args</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span></div>
<div class="viewcode-block" id="package_list_asps"><a class="viewcode-back" href="../../../../package.html#org.wayround.aipsetup.package.package_list_asps">[docs]</a><span class="sd">    List installed package&#39;s ASPs</span>

<span class="sd">    [-b=DIRNAME] NAME</span>

<span class="sd">    -b is same as in install</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="n">basedir</span> <span class="o">=</span> <span class="s">&#39;/&#39;</span>
    <span class="k">if</span> <span class="s">&#39;-b&#39;</span> <span class="ow">in</span> <span class="n">opts</span><span class="p">:</span>
        <span class="n">basedir</span> <span class="o">=</span> <span class="n">opts</span><span class="p">[</span><span class="s">&#39;-b&#39;</span><span class="p">]</span>

    <span class="n">name</span> <span class="o">=</span> <span class="bp">None</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&quot;Package name required&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>

        <span class="n">name</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">basedir</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&quot;given basedir name is wrong&quot;</span><span class="p">)</span>
            <span class="n">ret</span> <span class="o">=</span> <span class="mi">2</span>

        <span class="k">else</span><span class="p">:</span>

            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;Searching ASPs for package `{}&#39;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="p">))</span>

            <span class="n">lst</span> <span class="o">=</span> <span class="n">list_installed_package_s_asps</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">basedir</span><span class="p">)</span>

            <span class="n">lst</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span>
                <span class="n">reverse</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
                <span class="n">key</span><span class="o">=</span><span class="n">functools</span><span class="o">.</span><span class="n">cmp_to_key</span><span class="p">(</span>
                    <span class="n">org</span><span class="o">.</span><span class="n">wayround</span><span class="o">.</span><span class="n">aipsetup</span><span class="o">.</span><span class="n">version</span><span class="o">.</span><span class="n">package_version_comparator</span>
                    <span class="p">)</span>
                <span class="p">)</span>

            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">lst</span><span class="p">:</span>
                <span class="k">print</span><span class="p">(</span><span class="s">&quot;    {}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">ret</span>


<span class="k">def</span> <span class="nf">package_remove</span><span class="p">(</span><span class="n">opts</span><span class="p">,</span> <span class="n">args</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span></div>
<div class="viewcode-block" id="package_remove"><a class="viewcode-back" href="../../../../package.html#org.wayround.aipsetup.package.package_remove">[docs]</a><span class="sd">    Removes package matching NAME.</span>

<span class="sd">    [-b=DIRNAME] [--force] NAME</span>

<span class="sd">    --force    force removal of packages for which info is not</span>
<span class="sd">               available or which is not removable</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="n">basedir</span> <span class="o">=</span> <span class="s">&#39;/&#39;</span>
    <span class="k">if</span> <span class="s">&#39;-b&#39;</span> <span class="ow">in</span> <span class="n">opts</span><span class="p">:</span>
        <span class="n">basedir</span> <span class="o">=</span> <span class="n">opts</span><span class="p">[</span><span class="s">&#39;-b&#39;</span><span class="p">]</span>

    <span class="n">force</span> <span class="o">=</span> <span class="s">&#39;--force&#39;</span> <span class="ow">in</span> <span class="n">opts</span>

    <span class="n">name</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">name</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">basedir</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&quot;given basedir name is wrong&quot;</span><span class="p">)</span>
        <span class="n">ret</span> <span class="o">=</span> <span class="mi">2</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&quot;package to remove not named!&quot;</span><span class="p">)</span>
        <span class="n">ret</span> <span class="o">=</span> <span class="mi">3</span>

    <span class="k">if</span> <span class="n">ret</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">ret</span> <span class="o">=</span> <span class="n">remove_package</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">force</span><span class="p">,</span> <span class="n">basedir</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">ret</span>

<span class="k">def</span> <span class="nf">package_complete</span><span class="p">(</span><span class="n">opts</span><span class="p">,</span> <span class="n">args</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span></div>
<div class="viewcode-block" id="package_complete"><a class="viewcode-back" href="../../../../package.html#org.wayround.aipsetup.package.package_complete">[docs]</a><span class="sd">    Complete package building process: build complete; pack complete</span>

<span class="sd">    [DIRNAME] [TARBALL]</span>

<span class="sd">    [DIRNAME1] [DIRNAME2] [DIRNAMEn]</span>

<span class="sd">    This command has two modes of work:</span>

<span class="sd">       1. Working with single dir, which is pointed or not pointed by</span>
<span class="sd">          first parameter. In this mode, a tarball can be passed,</span>
<span class="sd">          which name will be used to apply new package info to pointed</span>
<span class="sd">          dir. By default DIRNAME is \`.\&#39; (current dir)</span>

<span class="sd">       2. Working with multiple dirs. In this mode, tarball can&#39;t be</span>
<span class="sd">          passed.</span>

<span class="sd">    options:</span>

<span class="sd">    -d - remove buildingsite on success</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">dirname</span> <span class="o">=</span> <span class="s">&#39;.&#39;</span>
    <span class="nb">file</span> <span class="o">=</span> <span class="bp">None</span>

    <span class="n">r_bds</span> <span class="o">=</span> <span class="s">&#39;-d&#39;</span> <span class="ow">in</span> <span class="n">opts</span>


    <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="n">args_l</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">args_l</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>

        <span class="n">dirname</span> <span class="o">=</span> <span class="s">&#39;.&#39;</span>
        <span class="nb">file</span> <span class="o">=</span> <span class="bp">None</span>

        <span class="n">ret</span> <span class="o">=</span> <span class="n">complete</span><span class="p">(</span>
            <span class="n">dirname</span><span class="p">,</span> <span class="nb">file</span><span class="p">,</span> <span class="n">remove_buildingsite_after_success</span><span class="o">=</span><span class="n">r_bds</span>
            <span class="p">)</span>

    <span class="k">elif</span> <span class="n">args_l</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>

        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>

            <span class="n">dirname</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="nb">file</span> <span class="o">=</span> <span class="bp">None</span>

        <span class="k">elif</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>

            <span class="n">dirname</span> <span class="o">=</span> <span class="s">&#39;.&#39;</span>
            <span class="nb">file</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="k">else</span><span class="p">:</span>

            <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&quot;{} not a dir and not a file&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">())</span>
            <span class="n">ret</span> <span class="o">=</span> <span class="mi">2</span>

        <span class="k">if</span> <span class="n">ret</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>

            <span class="n">ret</span> <span class="o">=</span> <span class="n">complete</span><span class="p">(</span>
                <span class="n">dirname</span><span class="p">,</span> <span class="nb">file</span><span class="p">,</span> <span class="n">remove_buildingsite_after_success</span><span class="o">=</span><span class="n">r_bds</span>
                <span class="p">)</span>

    <span class="k">elif</span> <span class="n">args_l</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>

        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>

            <span class="n">dirname</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="nb">file</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

            <span class="n">ret</span> <span class="o">=</span> <span class="n">complete</span><span class="p">(</span>
                <span class="n">dirname</span><span class="p">,</span> <span class="nb">file</span><span class="p">,</span> <span class="n">remove_buildingsite_after_success</span><span class="o">=</span><span class="n">r_bds</span>
                <span class="p">)</span>

        <span class="k">elif</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>

            <span class="nb">file</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">args</span><span class="p">[:</span><span class="mi">2</span><span class="p">]:</span>
                <span class="k">if</span> <span class="n">complete</span><span class="p">(</span>
                    <span class="n">i</span><span class="p">,</span> <span class="nb">file</span><span class="p">,</span> <span class="n">remove_buildingsite_after_success</span><span class="o">=</span><span class="n">r_bds</span>
                    <span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>

                    <span class="n">ret</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&quot;Wrong arguments&quot;</span><span class="p">)</span>


    <span class="k">elif</span> <span class="n">args_l</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>

        <span class="nb">file</span> <span class="o">=</span> <span class="bp">None</span>

        <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">args</span><span class="p">[</span><span class="mi">2</span><span class="p">:]:</span>
            <span class="k">if</span> <span class="n">complete</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="nb">file</span><span class="p">,</span> <span class="n">remove_buildingsite_after_success</span><span class="o">=</span><span class="n">r_bds</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">ret</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s">&quot;Programming error&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">ret</span>

<span class="k">def</span> <span class="nf">package_build</span><span class="p">(</span><span class="n">opts</span><span class="p">,</span> <span class="n">args</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span></div>
<div class="viewcode-block" id="package_build"><a class="viewcode-back" href="../../../../package.html#org.wayround.aipsetup.package.package_build">[docs]</a><span class="sd">    Place named source files in new building site and build new</span>
<span class="sd">    package from them.</span>

<span class="sd">    [-o] TARBALL[, TARBALL[, TARBALL[, TARBALL...]]]</span>

<span class="sd">    ======= ====================================</span>
<span class="sd">    options meaning</span>
<span class="sd">    ======= ====================================</span>
<span class="sd">    -o 	    treat all tarballs as for one build</span>
<span class="sd">    -d      remove buildingsite on success</span>
<span class="sd">    ======= ====================================</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">r_bds</span> <span class="o">=</span> <span class="s">&#39;-d&#39;</span> <span class="ow">in</span> <span class="n">opts</span>

    <span class="n">sources</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="n">multiple_packages</span> <span class="o">=</span> <span class="ow">not</span> <span class="s">&#39;-o&#39;</span> <span class="ow">in</span> <span class="n">opts</span>

    <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="n">org</span><span class="o">.</span><span class="n">wayround</span><span class="o">.</span><span class="n">aipsetup</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&#39;buildingsites&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span>
        <span class="p">)</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">sources</span> <span class="o">=</span> <span class="n">args</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sources</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&quot;No source files named&quot;</span><span class="p">)</span>
        <span class="n">ret</span> <span class="o">=</span> <span class="mi">2</span>

    <span class="k">if</span> <span class="n">ret</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>

        <span class="k">if</span> <span class="n">multiple_packages</span><span class="p">:</span>
            <span class="n">sources</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">sources</span><span class="p">:</span>
                <span class="n">build</span><span class="p">([</span><span class="n">i</span><span class="p">],</span> <span class="n">remove_buildingsite_after_success</span><span class="o">=</span><span class="n">r_bds</span><span class="p">)</span>
            <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ret</span> <span class="o">=</span> <span class="n">build</span><span class="p">(</span><span class="n">sources</span><span class="p">,</span> <span class="n">remove_buildingsite_after_success</span><span class="o">=</span><span class="n">r_bds</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">ret</span>

<span class="k">def</span> <span class="nf">package_find_files</span><span class="p">(</span><span class="n">opts</span><span class="p">,</span> <span class="n">args</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span></div>
<div class="viewcode-block" id="package_find_files"><a class="viewcode-back" href="../../../../package.html#org.wayround.aipsetup.package.package_find_files">[docs]</a><span class="sd">    Looks for LOOKFOR in all installed packages using one of methods:</span>

<span class="sd">    [-b=DIRNAME] [-m=beg|re|plain|sub|fm] LOOKFOR</span>

<span class="sd">    ================ ===================================</span>
<span class="sd">    -m option values meanings</span>
<span class="sd">    ================ ===================================</span>
<span class="sd">    sub              (default) filename contains LOOKFOR</span>
<span class="sd">    re               LOOKFOR is RegExp</span>
<span class="sd">    beg              file name starts with LOOKFOR</span>
<span class="sd">    plain            Exact LOOKFOR match</span>
<span class="sd">    fm               LOOKFOR is file mask</span>
<span class="sd">    ================ ===================================</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">basedir</span> <span class="o">=</span> <span class="s">&#39;/&#39;</span>
    <span class="k">if</span> <span class="s">&#39;-b&#39;</span> <span class="ow">in</span> <span class="n">opts</span><span class="p">:</span>
        <span class="n">basedir</span> <span class="o">=</span> <span class="n">opts</span><span class="p">[</span><span class="s">&#39;-b&#39;</span><span class="p">]</span>

    <span class="n">look_meth</span> <span class="o">=</span> <span class="s">&#39;sub&#39;</span>
    <span class="k">if</span> <span class="s">&#39;-m&#39;</span> <span class="ow">in</span> <span class="n">opts</span><span class="p">:</span>
        <span class="n">look_meth</span> <span class="o">=</span> <span class="n">opts</span><span class="p">[</span><span class="s">&#39;-m&#39;</span><span class="p">]</span>

    <span class="n">lookfor</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">lookfor</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="n">ret</span> <span class="o">=</span> <span class="n">find_file_in_files_installed_by_asps</span><span class="p">(</span>
        <span class="n">basedir</span><span class="p">,</span> <span class="n">lookfor</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="n">look_meth</span>
        <span class="p">)</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ret</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>

        <span class="n">rd_keys</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">ret</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">rd_keys</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;Not found&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="s">&quot;Found {num} packages with `{inc}&#39;&quot;</span><span class="o">.</span><span class="n">format_map</span><span class="p">(</span>
                    <span class="p">{</span>
                        <span class="s">&#39;num&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">rd_keys</span><span class="p">),</span>
                        <span class="s">&#39;inc&#39;</span><span class="p">:</span> <span class="n">lookfor</span>
                        <span class="p">}</span>
                    <span class="p">)</span>
                <span class="p">)</span>

            <span class="k">print</span><span class="p">(</span><span class="s">&quot;&quot;</span><span class="p">)</span>
            <span class="n">rd_keys</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>

            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">rd_keys</span><span class="p">:</span>
                <span class="k">print</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\t</span><span class="s">{}:&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>

                <span class="n">pp_lst</span> <span class="o">=</span> <span class="n">ret</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="n">pp_lst</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>

                <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">pp_lst</span><span class="p">:</span>
                    <span class="k">print</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\t\t</span><span class="s">{}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">j</span><span class="p">))</span>

                <span class="k">print</span><span class="p">(</span><span class="s">&quot;&quot;</span><span class="p">)</span>
        <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="n">ret</span> <span class="o">=</span> <span class="mi">1</span>

    <span class="k">return</span> <span class="n">ret</span>

<span class="k">def</span> <span class="nf">package_check_package</span><span class="p">(</span><span class="n">opts</span><span class="p">,</span> <span class="n">args</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span></div>
<div class="viewcode-block" id="package_check_package"><a class="viewcode-back" href="../../../../package.html#org.wayround.aipsetup.package.package_check_package">[docs]</a><span class="sd">    Check package for errors</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="nb">file</span> <span class="o">=</span> <span class="bp">None</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="nb">file</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="k">if</span> <span class="nb">file</span> <span class="o">==</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&quot;Filename required&quot;</span><span class="p">)</span>
        <span class="n">ret</span> <span class="o">=</span> <span class="mi">2</span>

    <span class="k">else</span><span class="p">:</span>

        <span class="n">ret</span> <span class="o">=</span> <span class="n">check_package</span><span class="p">(</span><span class="nb">file</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">ret</span>


<span class="k">def</span> <span class="nf">check_package</span><span class="p">(</span><span class="n">asp_name</span><span class="p">,</span> <span class="n">mute</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span></div>
<div class="viewcode-block" id="check_package"><a class="viewcode-back" href="../../../../package.html#org.wayround.aipsetup.package.check_package">[docs]</a><span class="sd">    Check package for errors</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="n">asp_name</span> <span class="o">=</span> <span class="n">org</span><span class="o">.</span><span class="n">wayround</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">asp_name</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">asp_name</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s">&#39;.asp&#39;</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">mute</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&quot;Wrong file extension `{}&#39;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">asp_name</span><span class="p">))</span>
        <span class="n">ret</span> <span class="o">=</span> <span class="mi">3</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">tarf</span> <span class="o">=</span> <span class="n">tarfile</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">asp_name</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s">&#39;r&#39;</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s">&quot;Can&#39;t open file `{}&#39;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">asp_name</span><span class="p">))</span>
            <span class="n">ret</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">f</span> <span class="o">=</span> <span class="n">org</span><span class="o">.</span><span class="n">wayround</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">archive</span><span class="o">.</span><span class="n">tar_member_get_extract_file</span><span class="p">(</span>
                    <span class="n">tarf</span><span class="p">,</span>
                    <span class="s">&#39;./package.sha512&#39;</span>
                    <span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">tarfile</span><span class="o">.</span><span class="n">ExFileObject</span><span class="p">):</span>
                    <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&quot;Can&#39;t get checksums from package file&quot;</span><span class="p">)</span>
                    <span class="n">ret</span> <span class="o">=</span> <span class="mi">2</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">sums_txt</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                    <span class="n">sums</span> <span class="o">=</span> <span class="n">org</span><span class="o">.</span><span class="n">wayround</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">checksum</span><span class="o">.</span><span class="n">parse_checksums_text</span><span class="p">(</span>
                        <span class="n">sums_txt</span>
                        <span class="p">)</span>
                    <span class="k">del</span><span class="p">(</span><span class="n">sums_txt</span><span class="p">)</span>

                    <span class="n">sums2</span> <span class="o">=</span> <span class="p">{}</span>
                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">sums</span><span class="p">:</span>
                        <span class="n">sums2</span><span class="p">[</span><span class="s">&#39;.&#39;</span> <span class="o">+</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">sums</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                    <span class="n">sums</span> <span class="o">=</span> <span class="n">sums2</span>
                    <span class="k">del</span><span class="p">(</span><span class="n">sums2</span><span class="p">)</span>

                    <span class="n">tar_members</span> <span class="o">=</span> <span class="n">tarf</span><span class="o">.</span><span class="n">getmembers</span><span class="p">()</span>

                    <span class="n">check_list</span> <span class="o">=</span> <span class="p">[</span>
                        <span class="s">&#39;./04.DESTDIR.tar.xz&#39;</span><span class="p">,</span> <span class="s">&#39;./05.BUILD_LOGS.tar.xz&#39;</span><span class="p">,</span>
                        <span class="s">&#39;./package_info.json&#39;</span><span class="p">,</span> <span class="s">&#39;./02.PATCHES.tar.xz&#39;</span>
                        <span class="p">]</span>

                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="p">[</span><span class="s">&#39;./00.TARBALL&#39;</span><span class="p">,</span> <span class="s">&#39;./06.LISTS&#39;</span><span class="p">]:</span>
                        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">tar_members</span><span class="p">:</span>
                            <span class="k">if</span> <span class="p">(</span>
                                <span class="n">j</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
                                <span class="ow">and</span> <span class="n">j</span><span class="o">.</span><span class="n">name</span> <span class="o">!=</span> <span class="n">i</span>
                                <span class="p">):</span>
                                <span class="n">check_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">j</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

                    <span class="n">check_list</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>

                    <span class="n">error_found</span> <span class="o">=</span> <span class="bp">False</span>

                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">check_list</span><span class="p">:</span>
                        <span class="n">cresult</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
                        <span class="k">if</span> <span class="p">(</span>
                            <span class="ow">not</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">sums</span>
                            <span class="ow">or</span> <span class="n">tarobj_check_member_sum</span><span class="p">(</span><span class="n">tarf</span><span class="p">,</span> <span class="n">sums</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="o">==</span> <span class="bp">False</span>
                            <span class="p">):</span>
                            <span class="n">error_found</span> <span class="o">=</span> <span class="bp">True</span>
                            <span class="n">cresult</span> <span class="o">=</span> <span class="s">&quot;FAIL&quot;</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">cresult</span> <span class="o">=</span> <span class="s">&quot;OK&quot;</span>

                        <span class="k">if</span> <span class="ow">not</span> <span class="n">mute</span><span class="p">:</span>
                            <span class="k">print</span><span class="p">(</span>
                                <span class="s">&quot;       {name} - {result}&quot;</span><span class="o">.</span><span class="n">format_map</span><span class="p">(</span>
                                    <span class="p">{</span>
                                        <span class="s">&#39;name&#39;</span><span class="p">:</span> <span class="n">i</span><span class="p">,</span>
                                        <span class="s">&#39;result&#39;</span><span class="p">:</span> <span class="n">cresult</span>
                                        <span class="p">}</span>
                                    <span class="p">)</span>
                                <span class="p">)</span>

                    <span class="k">if</span> <span class="n">error_found</span><span class="p">:</span>
                        <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&quot;Error was found while checking package&quot;</span><span class="p">)</span>
                        <span class="n">ret</span> <span class="o">=</span> <span class="mi">3</span>
                    <span class="k">else</span><span class="p">:</span>

                        <span class="c"># TODO: additionally to this leaf, make test</span>
                        <span class="c">#       by tar -t output</span>

                        <span class="n">fobj</span> <span class="o">=</span> <span class="n">org</span><span class="o">.</span><span class="n">wayround</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">archive</span><span class="o">.</span><span class="n">tar_member_get_extract_file</span><span class="p">(</span>
                            <span class="n">tarf</span><span class="p">,</span>
                            <span class="s">&#39;./06.LISTS/DESTDIR.lst.xz&#39;</span>
                            <span class="p">)</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">fobj</span><span class="p">,</span> <span class="n">tarfile</span><span class="o">.</span><span class="n">ExFileObject</span><span class="p">):</span>
                            <span class="n">ret</span> <span class="o">=</span> <span class="bp">False</span>
                        <span class="k">else</span><span class="p">:</span>

                            <span class="k">try</span><span class="p">:</span>
                                <span class="n">dest_dir_files_list</span> <span class="o">=</span> <span class="n">org</span><span class="o">.</span><span class="n">wayround</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">archive</span><span class="o">.</span><span class="n">xzcat</span><span class="p">(</span>
                                    <span class="n">fobj</span><span class="p">,</span>
                                    <span class="n">convert_to_str</span><span class="o">=</span><span class="s">&#39;utf-8&#39;</span>
                                    <span class="p">)</span>
                                <span class="n">dest_dir_files_list</span> <span class="o">=</span> <span class="n">dest_dir_files_list</span><span class="o">.</span><span class="n">splitlines</span><span class="p">()</span>

                                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="p">[</span>
                                    <span class="s">&#39;bin&#39;</span><span class="p">,</span>
                                    <span class="s">&#39;sbin&#39;</span><span class="p">,</span>
                                    <span class="s">&#39;lib&#39;</span><span class="p">,</span>
                                    <span class="s">&#39;lib64&#39;</span>
                                    <span class="p">]:</span>

                                    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">dest_dir_files_list</span><span class="p">:</span>

                                        <span class="n">p1</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">sep</span> <span class="o">+</span> <span class="n">i</span> <span class="o">+</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">sep</span>
                                        <span class="n">p2</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">sep</span> <span class="o">+</span> <span class="n">i</span>

                                        <span class="k">if</span> <span class="n">j</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">p1</span><span class="p">):</span>
                                            <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                                                <span class="s">&quot;{} has file paths starting with {}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                                                    <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">asp_name</span><span class="p">),</span>
                                                    <span class="n">p1</span>
                                                    <span class="p">)</span>
                                                <span class="p">)</span>
                                            <span class="n">ret</span> <span class="o">=</span> <span class="mi">5</span>
                                            <span class="k">break</span>

                                        <span class="k">elif</span> <span class="n">j</span> <span class="o">==</span> <span class="n">p2</span><span class="p">:</span>
                                            <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                                                <span class="s">&quot;{} has file paths equal to {}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                                                    <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">asp_name</span><span class="p">),</span>
                                                    <span class="n">p2</span>
                                                    <span class="p">)</span>
                                                <span class="p">)</span>
                                            <span class="n">ret</span> <span class="o">=</span> <span class="mi">5</span>
                                            <span class="k">break</span>

                                        <span class="k">if</span> <span class="n">ret</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                                            <span class="k">break</span>

                            <span class="k">except</span><span class="p">:</span>
                                <span class="n">logging</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s">&quot;Error&quot;</span><span class="p">)</span>
                                <span class="n">ret</span> <span class="o">=</span> <span class="mi">4</span>
                            <span class="k">finally</span><span class="p">:</span>
                                <span class="n">fobj</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="k">finally</span><span class="p">:</span>
                <span class="n">tarf</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">ret</span>

<span class="k">def</span> <span class="nf">check_package_aipsetup2</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span></div>
<div class="viewcode-block" id="check_package_aipsetup2"><a class="viewcode-back" href="../../../../package.html#org.wayround.aipsetup.package.check_package_aipsetup2">[docs]</a><span class="sd">    Check aipsetup v2 package consistency</span>

<span class="sd">    :rtype: ``0`` - if no errors.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="n">filename</span> <span class="o">=</span> <span class="n">org</span><span class="o">.</span><span class="n">wayround</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">filename</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s">&#39;.tar.xz&#39;</span><span class="p">):</span>
        <span class="n">ret</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">filename_sha512</span> <span class="o">=</span> <span class="n">filename</span> <span class="o">+</span> <span class="s">&#39;.sha512&#39;</span>
        <span class="n">filename_md5</span> <span class="o">=</span> <span class="n">filename</span> <span class="o">+</span> <span class="s">&#39;.md5&#39;</span>

        <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
            <span class="ow">or</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">filename_sha512</span><span class="p">)</span>
            <span class="ow">or</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">filename_md5</span><span class="p">)</span>
            <span class="p">):</span>
            <span class="n">ret</span> <span class="o">=</span> <span class="mi">2</span>
        <span class="k">else</span><span class="p">:</span>

            <span class="n">bn</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
            <span class="n">dbn</span> <span class="o">=</span> <span class="s">&#39;./&#39;</span> <span class="o">+</span> <span class="n">bn</span>

            <span class="n">sha512</span> <span class="o">=</span> <span class="n">org</span><span class="o">.</span><span class="n">wayround</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">checksum</span><span class="o">.</span><span class="n">make_file_checksum</span><span class="p">(</span>
                <span class="n">filename</span><span class="p">,</span> <span class="s">&#39;sha512&#39;</span>
                <span class="p">)</span>

            <span class="n">md5</span> <span class="o">=</span> <span class="n">org</span><span class="o">.</span><span class="n">wayround</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">checksum</span><span class="o">.</span><span class="n">make_file_checksum</span><span class="p">(</span>
                <span class="n">filename</span><span class="p">,</span> <span class="s">&#39;md5&#39;</span>
                <span class="p">)</span>

            <span class="n">sha512s</span> <span class="o">=</span> <span class="n">org</span><span class="o">.</span><span class="n">wayround</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">checksum</span><span class="o">.</span><span class="n">parse_checksums_file_text</span><span class="p">(</span>
                <span class="n">filename_sha512</span>
                <span class="p">)</span>

            <span class="n">md5s</span> <span class="o">=</span> <span class="n">org</span><span class="o">.</span><span class="n">wayround</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">checksum</span><span class="o">.</span><span class="n">parse_checksums_file_text</span><span class="p">(</span>
                <span class="n">filename_md5</span>
                <span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">sha512</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="n">ret</span> <span class="o">=</span> <span class="mi">3</span>
            <span class="k">elif</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">md5</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="n">ret</span> <span class="o">=</span> <span class="mi">4</span>
            <span class="k">elif</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">sha512s</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                <span class="n">ret</span> <span class="o">=</span> <span class="mi">5</span>
            <span class="k">elif</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">md5s</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                <span class="n">ret</span> <span class="o">=</span> <span class="mi">6</span>
            <span class="k">elif</span> <span class="ow">not</span> <span class="n">dbn</span> <span class="ow">in</span> <span class="n">sha512s</span><span class="p">:</span>
                <span class="n">ret</span> <span class="o">=</span> <span class="mi">7</span>
            <span class="k">elif</span> <span class="ow">not</span> <span class="n">dbn</span> <span class="ow">in</span> <span class="n">md5s</span><span class="p">:</span>
                <span class="n">ret</span> <span class="o">=</span> <span class="mi">8</span>
            <span class="k">elif</span> <span class="ow">not</span> <span class="n">sha512s</span><span class="p">[</span><span class="n">dbn</span><span class="p">]</span> <span class="o">==</span> <span class="n">sha512</span><span class="p">:</span>
                <span class="n">ret</span> <span class="o">=</span> <span class="mi">9</span>
            <span class="k">elif</span> <span class="ow">not</span> <span class="n">md5s</span><span class="p">[</span><span class="n">dbn</span><span class="p">]</span> <span class="o">==</span> <span class="n">md5</span><span class="p">:</span>
                <span class="n">ret</span> <span class="o">=</span> <span class="mi">10</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">return</span> <span class="n">ret</span>


<span class="k">def</span> <span class="nf">tarobj_check_member_sum</span><span class="p">(</span><span class="n">tarobj</span><span class="p">,</span> <span class="n">sums</span><span class="p">,</span> <span class="n">member_name</span><span class="p">):</span>
</div>
<div class="viewcode-block" id="tarobj_check_member_sum"><a class="viewcode-back" href="../../../../package.html#org.wayround.aipsetup.package.tarobj_check_member_sum">[docs]</a>    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Check tarball member checksum.</span>

<span class="sd">    Sums must be supplied with sums parameter, which must be dict of building::</span>

<span class="sd">        sums == {&#39;filename&#39;:&#39;checksum&#39;}</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">ret</span> <span class="o">=</span> <span class="bp">True</span>

    <span class="n">fobj</span> <span class="o">=</span> <span class="n">org</span><span class="o">.</span><span class="n">wayround</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">archive</span><span class="o">.</span><span class="n">tar_member_get_extract_file</span><span class="p">(</span>
        <span class="n">tarobj</span><span class="p">,</span>
        <span class="n">member_name</span>
        <span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">fobj</span><span class="p">,</span> <span class="n">tarfile</span><span class="o">.</span><span class="n">ExFileObject</span><span class="p">):</span>
        <span class="n">ret</span> <span class="o">=</span> <span class="bp">False</span>
    <span class="k">else</span><span class="p">:</span>

        <span class="n">summ</span> <span class="o">=</span> <span class="n">org</span><span class="o">.</span><span class="n">wayround</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">checksum</span><span class="o">.</span><span class="n">make_fileobj_checksum</span><span class="p">(</span><span class="n">fobj</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">summ</span> <span class="o">==</span> <span class="n">sums</span><span class="p">[</span><span class="n">member_name</span><span class="p">]:</span>
            <span class="n">ret</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ret</span> <span class="o">=</span> <span class="bp">False</span>

        <span class="n">fobj</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">ret</span>



<span class="k">def</span> <span class="nf">remove_package</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">force</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">destdir</span><span class="o">=</span><span class="s">&#39;/&#39;</span><span class="p">,</span> <span class="n">mute</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span></div>
<div class="viewcode-block" id="remove_package"><a class="viewcode-back" href="../../../../package.html#org.wayround.aipsetup.package.remove_package">[docs]</a><span class="sd">    Remove named package (all it&#39;s installed asps) from system.</span>

<span class="sd">    Before package removal, aipsetup checks whatever package removal is</span>
<span class="sd">    restricted. This can be overridden with ``force=True`` option.</span>

<span class="sd">    :param name: package name. e.g. ``gajim``, ``php`` or ``ruby``. List of</span>
<span class="sd">        installed package names can be retrieved with command ``aipsetup pkg</span>
<span class="sd">        list``</span>

<span class="sd">    :param destdir: path to root directory of target system</span>

<span class="sd">    :param force: force package removal even if it is not registered in info</span>
<span class="sd">        record system</span>

<span class="sd">    :param mute: suppress status output</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="n">info</span> <span class="o">=</span> <span class="n">org</span><span class="o">.</span><span class="n">wayround</span><span class="o">.</span><span class="n">aipsetup</span><span class="o">.</span><span class="n">pkginfo</span><span class="o">.</span><span class="n">get_package_info_record</span><span class="p">(</span>
        <span class="n">name</span>
        <span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">force</span><span class="p">:</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&quot;Can&#39;t find information about package `{}&#39;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="p">))</span>

        <span class="n">ret</span> <span class="o">=</span> <span class="mi">1</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">force</span> <span class="ow">and</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">info</span><span class="p">[</span><span class="s">&#39;removable&#39;</span><span class="p">]):</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&quot;Package `{}&#39; is not removable&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="p">))</span>

            <span class="n">ret</span> <span class="o">=</span> <span class="mi">2</span>

        <span class="k">else</span><span class="p">:</span>

            <span class="n">lst</span> <span class="o">=</span> <span class="n">list_installed_package_s_asps</span><span class="p">(</span>
                <span class="n">name</span><span class="p">,</span> <span class="n">destdir</span>
                <span class="p">)</span>

            <span class="n">lst</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span>
                <span class="n">reverse</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
                <span class="n">key</span><span class="o">=</span><span class="n">functools</span><span class="o">.</span><span class="n">cmp_to_key</span><span class="p">(</span>
                    <span class="n">org</span><span class="o">.</span><span class="n">wayround</span><span class="o">.</span><span class="n">aipsetup</span><span class="o">.</span><span class="n">version</span><span class="o">.</span><span class="n">package_version_comparator</span>
                    <span class="p">)</span>
                <span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">mute</span><span class="p">:</span>
                <span class="k">print</span><span class="p">(</span><span class="s">&quot;Following packages will be removed:&quot;</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">lst</span><span class="p">:</span>
                    <span class="k">print</span><span class="p">(</span><span class="s">&quot;    {}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>

            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">lst</span><span class="p">:</span>

                <span class="n">name</span> <span class="o">=</span> <span class="n">org</span><span class="o">.</span><span class="n">wayround</span><span class="o">.</span><span class="n">aipsetup</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">rm_ext_from_pkg_name</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>

                <span class="k">if</span> <span class="ow">not</span> <span class="n">mute</span><span class="p">:</span>
                    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;Removing package `{}&#39;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="p">))</span>
                <span class="n">remove_asp</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">destdir</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">ret</span>



<span class="k">def</span> <span class="nf">install_package</span><span class="p">(</span>
    <span class="n">name</span><span class="p">,</span> <span class="n">force</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">destdir</span><span class="o">=</span><span class="s">&#39;/&#39;</span></div>
<div class="viewcode-block" id="install_package"><a class="viewcode-back" href="../../../../package.html#org.wayround.aipsetup.package.install_package">[docs]</a>    <span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Install package</span>

<span class="sd">    This function works in two modes:</span>

<span class="sd">        One mode, is when name is package name registered with package database</span>
<span class="sd">        records. In this case, aipsetup finds latest asp package located in</span>
<span class="sd">        package index directory and calls this(install_package) function with</span>
<span class="sd">        ``name == &#39;full path to asp&#39;``</span>

<span class="sd">        Second mode, is when name is pointing on existing file. In this case</span>
<span class="sd">        next sequence is done:</span>

<span class="sd">            #. install package using :func:`install_asp`</span>

<span class="sd">            #. check whatever package is reducible, and if it is — reduce older</span>
<span class="sd">               asps from system using :func:`reduce_asps`</span>

<span class="sd">    &quot;&quot;&quot;</span>


    <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">name</span><span class="p">):</span>
        <span class="n">name_parsed</span> <span class="o">=</span> <span class="n">org</span><span class="o">.</span><span class="n">wayround</span><span class="o">.</span><span class="n">aipsetup</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">package_name_parse</span><span class="p">(</span>
            <span class="n">name</span><span class="p">,</span> <span class="n">mute</span><span class="o">=</span><span class="bp">True</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">force</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">name_parsed</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&quot;Can&#39;t parse `{}&#39; as package name&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="p">))</span>
            <span class="n">ret</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>

            <span class="n">info</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">name_parsed</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                <span class="n">info</span> <span class="o">=</span> <span class="n">org</span><span class="o">.</span><span class="n">wayround</span><span class="o">.</span><span class="n">aipsetup</span><span class="o">.</span><span class="n">pkginfo</span><span class="o">.</span><span class="n">get_package_info_record</span><span class="p">(</span>
                    <span class="n">name_parsed</span><span class="p">[</span><span class="s">&#39;groups&#39;</span><span class="p">][</span><span class="s">&#39;name&#39;</span><span class="p">]</span>
                    <span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">force</span><span class="p">:</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                    <span class="s">&quot;Can&#39;t get info on package `{}&#39; : `{}&#39;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="n">name_parsed</span><span class="p">[</span><span class="s">&#39;groups&#39;</span><span class="p">][</span><span class="s">&#39;name&#39;</span><span class="p">],</span> <span class="n">name</span><span class="p">)</span>
                        <span class="p">)</span>
                <span class="n">ret</span> <span class="o">=</span> <span class="mi">2</span>
            <span class="k">else</span><span class="p">:</span>

                <span class="n">asps</span> <span class="o">=</span> <span class="n">list_installed_package_s_asps</span><span class="p">(</span>
                    <span class="n">name_parsed</span><span class="p">[</span><span class="s">&#39;groups&#39;</span><span class="p">][</span><span class="s">&#39;name&#39;</span><span class="p">],</span> <span class="n">destdir</span>
                    <span class="p">)</span>

                <span class="n">ret</span> <span class="o">=</span> <span class="n">install_asp</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">destdir</span><span class="p">)</span>

                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">asps</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">ret</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;New ASP installation finished&quot;</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&quot;Some ASP installation errors&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">ret</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                            <span class="s">&quot;Some ASP installation errors encountered,&quot;</span>
                            <span class="s">&quot; so no updation following&quot;</span>
                            <span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                            <span class="k">if</span> <span class="n">info</span><span class="p">[</span><span class="s">&#39;reducible&#39;</span><span class="p">]:</span>
                                <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                                    <span class="s">&quot;Reducing `{}&#39; ASPs&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                                        <span class="n">name_parsed</span><span class="p">[</span><span class="s">&#39;groups&#39;</span><span class="p">][</span><span class="s">&#39;name&#39;</span><span class="p">]</span>
                                        <span class="p">)</span>
                                    <span class="p">)</span>
                                <span class="n">reduce_asps</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">asps</span><span class="p">,</span> <span class="n">destdir</span><span class="p">)</span>
                                <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                                    <span class="s">&quot;Reduced `{}&#39; ASPs&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                                        <span class="n">name_parsed</span><span class="p">[</span><span class="s">&#39;groups&#39;</span><span class="p">][</span><span class="s">&#39;name&#39;</span><span class="p">]</span>
                                        <span class="p">)</span>
                                    <span class="p">)</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="n">info</span> <span class="o">=</span> <span class="n">org</span><span class="o">.</span><span class="n">wayround</span><span class="o">.</span><span class="n">aipsetup</span><span class="o">.</span><span class="n">pkginfo</span><span class="o">.</span><span class="n">get_package_info_record</span><span class="p">(</span>
            <span class="n">name</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&quot;Don&#39;t know about package&quot;</span><span class="p">)</span>
            <span class="n">ret</span> <span class="o">=</span> <span class="mi">2</span>
        <span class="k">else</span><span class="p">:</span>

            <span class="n">latest_in_repo</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">org</span><span class="o">.</span><span class="n">wayround</span><span class="o">.</span><span class="n">aipsetup</span><span class="o">.</span><span class="n">pkglatest</span><span class="o">.</span><span class="n">get_latest_pkg_from_record</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
                <span class="p">)</span>

            <span class="k">if</span> <span class="n">latest_in_repo</span> <span class="o">==</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&quot;Repo has no latest package&quot;</span><span class="p">)</span>
                <span class="n">ret</span> <span class="o">=</span> <span class="mi">3</span>
            <span class="k">else</span><span class="p">:</span>

                <span class="n">full_name</span> <span class="o">=</span> <span class="n">org</span><span class="o">.</span><span class="n">wayround</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span>
                    <span class="n">org</span><span class="o">.</span><span class="n">wayround</span><span class="o">.</span><span class="n">aipsetup</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&#39;repository&#39;</span><span class="p">]</span> <span class="o">+</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">sep</span> <span class="o">+</span>
                    <span class="n">latest_in_repo</span>
                    <span class="p">)</span>

                <span class="n">ret</span> <span class="o">=</span> <span class="n">install_package</span><span class="p">(</span><span class="n">full_name</span><span class="p">,</span> <span class="bp">False</span><span class="p">,</span> <span class="n">destdir</span><span class="p">)</span>


    <span class="k">return</span> <span class="n">ret</span>

<span class="k">def</span> <span class="nf">install_asp</span><span class="p">(</span><span class="n">asp_name</span><span class="p">,</span> <span class="n">destdir</span><span class="o">=</span><span class="s">&#39;/&#39;</span><span class="p">):</span>
</div>
<div class="viewcode-block" id="install_asp"><a class="viewcode-back" href="../../../../package.html#org.wayround.aipsetup.package.install_asp">[docs]</a>    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Install asp package pointed by ``asp_name`` path.</span>

<span class="sd">    See also :func:`install_package`</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="n">destdir</span> <span class="o">=</span> <span class="n">org</span><span class="o">.</span><span class="n">wayround</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">destdir</span><span class="p">)</span>

    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;Performing package checks before it&#39;s installation&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">check_package</span><span class="p">(</span><span class="n">asp_name</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&quot;Package defective - installation failed&quot;</span><span class="p">)</span>
        <span class="n">ret</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">tarf</span> <span class="o">=</span> <span class="n">tarfile</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">asp_name</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s">&#39;r&#39;</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s">&quot;Can&#39;t open file `{}&#39;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">asp_name</span><span class="p">))</span>
            <span class="n">ret</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>

            <span class="n">package_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">asp_name</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">org</span><span class="o">.</span><span class="n">wayround</span><span class="o">.</span><span class="n">aipsetup</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">package_name_parse</span><span class="p">(</span>
                <span class="n">package_name</span>
                <span class="p">)</span> <span class="o">==</span> <span class="bp">None</span><span class="p">:</span>

                <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                    <span class="s">&quot;Can&#39;t parse package name `{}&#39;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">package_name</span><span class="p">)</span>
                    <span class="p">)</span>
                <span class="n">ret</span> <span class="o">=</span> <span class="mi">2</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="n">package_name</span> <span class="o">=</span> <span class="n">package_name</span><span class="p">[:</span><span class="o">-</span><span class="mi">4</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="p">[</span>
                    <span class="p">(</span>
                         <span class="s">&#39;./06.LISTS/DESTDIR.lst.xz&#39;</span><span class="p">,</span>
                         <span class="s">&#39;installed_pkg_dir&#39;</span><span class="p">,</span>
                         <span class="s">&quot;package&#39;s file list&quot;</span>
                         <span class="p">),</span>
                    <span class="p">(</span>
                         <span class="s">&#39;./06.LISTS/DESTDIR.sha512.xz&#39;</span><span class="p">,</span>
                         <span class="s">&#39;installed_pkg_dir_sums&#39;</span><span class="p">,</span>
                         <span class="s">&quot;package&#39;s check sums&quot;</span>
                         <span class="p">),</span>
                    <span class="p">(</span>
                         <span class="s">&#39;./05.BUILD_LOGS.tar.xz&#39;</span><span class="p">,</span>
                         <span class="s">&#39;installed_pkg_dir_buildlogs&#39;</span><span class="p">,</span>
                         <span class="s">&quot;package&#39;s buildlogs&quot;</span>
                         <span class="p">)</span>
                    <span class="p">]:</span>

                    <span class="n">logs_path</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
                    <span class="k">if</span> <span class="n">org</span><span class="o">.</span><span class="n">wayround</span><span class="o">.</span><span class="n">aipsetup</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="n">i</span><span class="p">[</span><span class="mi">1</span><span class="p">]][</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;/&#39;</span><span class="p">:</span>
                        <span class="n">logs_path</span> <span class="o">=</span> <span class="n">org</span><span class="o">.</span><span class="n">wayround</span><span class="o">.</span><span class="n">aipsetup</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="n">i</span><span class="p">[</span><span class="mi">1</span><span class="p">]][</span><span class="mi">1</span><span class="p">:]</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">logs_path</span> <span class="o">=</span> <span class="n">org</span><span class="o">.</span><span class="n">wayround</span><span class="o">.</span><span class="n">aipsetup</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="n">i</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>

                    <span class="n">out_filename</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="n">org</span><span class="o">.</span><span class="n">wayround</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span>
                            <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                                <span class="n">destdir</span><span class="p">,</span>
                                <span class="n">logs_path</span><span class="p">,</span>
                                <span class="n">package_name</span> <span class="o">+</span> <span class="s">&#39;.xz&#39;</span>
                                <span class="p">)</span>
                            <span class="p">)</span>
                        <span class="p">)</span>

                    <span class="n">out_filename_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">out_filename</span><span class="p">)</span>

                    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">out_filename_dir</span><span class="p">):</span>
                        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">out_filename_dir</span><span class="p">)</span>

                    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                        <span class="s">&quot;Installing {} as {}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                            <span class="n">i</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
                            <span class="n">out_filename</span>
                            <span class="p">)</span>
                        <span class="p">)</span>

                    <span class="k">if</span> <span class="n">org</span><span class="o">.</span><span class="n">wayround</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">archive</span><span class="o">.</span><span class="n">tar_member_get_extract_file_to</span><span class="p">(</span>
                            <span class="n">tarf</span><span class="p">,</span>
                            <span class="n">i</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                            <span class="n">out_filename</span>
                            <span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span> <span class="p">:</span>
                        <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                            <span class="s">&quot;Can&#39;t install asp {} as {}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                                <span class="n">i</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">out_filename</span>
                                <span class="p">)</span>
                            <span class="p">)</span>
                        <span class="n">ret</span> <span class="o">=</span> <span class="mi">2</span>
                        <span class="k">break</span>

                <span class="k">if</span> <span class="n">ret</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;Installing package&#39;s destdir&quot;</span><span class="p">)</span>

                    <span class="n">dd_fobj</span> <span class="o">=</span> <span class="n">org</span><span class="o">.</span><span class="n">wayround</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">archive</span><span class="o">.</span>\
                        <span class="n">tar_member_get_extract_file</span><span class="p">(</span>
                            <span class="n">tarf</span><span class="p">,</span> <span class="s">&#39;./04.DESTDIR.tar.xz&#39;</span>
                            <span class="p">)</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dd_fobj</span><span class="p">,</span> <span class="n">tarfile</span><span class="o">.</span><span class="n">ExFileObject</span><span class="p">):</span>
                        <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&quot;Can&#39;t get package&#39;s destdir&quot;</span><span class="p">)</span>
                        <span class="n">ret</span> <span class="o">=</span> <span class="mi">4</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">tec</span> <span class="o">=</span> <span class="n">org</span><span class="o">.</span><span class="n">wayround</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">archive</span><span class="o">.</span><span class="n">extract_tar_canonical_fobj</span><span class="p">(</span>
                                    <span class="n">dd_fobj</span><span class="p">,</span>
                                    <span class="n">destdir</span><span class="p">,</span>
                                    <span class="s">&#39;xz&#39;</span><span class="p">,</span>
                                    <span class="n">verbose_tar</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
                                    <span class="n">verbose_compressor</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
                                    <span class="n">add_tar_options</span><span class="o">=</span><span class="p">[</span>
                                        <span class="s">&#39;--no-same-owner&#39;</span><span class="p">,</span>
                                        <span class="s">&#39;--no-same-permissions&#39;</span>
                                        <span class="p">]</span>
                                    <span class="p">)</span>
                            <span class="k">if</span> <span class="n">tec</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                                <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                                    <span class="s">&quot;Package destdir decompression error:&quot;</span>
                                    <span class="s">&quot; tar exit code: {}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                                        <span class="n">tec</span>
                                    <span class="p">)</span>
                                <span class="p">)</span>
                                <span class="n">ret</span> <span class="o">=</span> <span class="mi">5</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span>
                                <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                                    <span class="s">&quot;Installed `{}&#39;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">package_name</span><span class="p">)</span>
                                    <span class="p">)</span>
                        <span class="k">finally</span><span class="p">:</span>
                            <span class="n">dd_fobj</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

                <span class="k">if</span> <span class="n">ret</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                        <span class="s">&quot;Post installation file ownerships and modes fix&quot;</span>
                        <span class="p">)</span>

                    <span class="n">files</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="n">dirs</span> <span class="o">=</span> <span class="p">[]</span>

                    <span class="n">installed_file_list</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="n">org</span><span class="o">.</span><span class="n">wayround</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">archive</span><span class="o">.</span><span class="n">tar_member_get_extract_file</span><span class="p">(</span>
                            <span class="n">tarf</span><span class="p">,</span> <span class="s">&#39;./06.LISTS/DESTDIR.lst.xz&#39;</span>
                            <span class="p">)</span>
                        <span class="p">)</span>

                    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">installed_file_list</span><span class="p">,</span> <span class="n">tarfile</span><span class="o">.</span><span class="n">ExFileObject</span><span class="p">):</span>
                        <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&quot;Can&#39;t get package&#39;s file list&quot;</span><span class="p">)</span>
                        <span class="n">ret</span> <span class="o">=</span> <span class="mi">10</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">text_lst</span> <span class="o">=</span> <span class="n">org</span><span class="o">.</span><span class="n">wayround</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">archive</span><span class="o">.</span><span class="n">xzcat</span><span class="p">(</span>
                                <span class="n">installed_file_list</span><span class="p">,</span> <span class="n">convert_to_str</span><span class="o">=</span><span class="s">&#39;utf-8&#39;</span>
                                <span class="p">)</span>

                            <span class="n">files</span> <span class="o">=</span> <span class="n">text_lst</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>

                            <span class="n">files</span> <span class="o">=</span> <span class="p">(</span>
                                <span class="n">org</span><span class="o">.</span><span class="n">wayround</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">list</span><span class="o">.</span><span class="n">filelist_strip_remove_empty_remove_duplicated_lines</span><span class="p">(</span><span class="n">files</span><span class="p">)</span>
                                <span class="p">)</span>

                            <span class="n">files</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>

                            <span class="n">dirs</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
                            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">files</span><span class="p">:</span>
                                <span class="n">dirs</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>
                            <span class="n">dirs</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">dirs</span><span class="p">)</span>
                            <span class="n">dirs</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>

                            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">dirs</span><span class="p">:</span>
                                <span class="n">f_d_p</span> <span class="o">=</span> <span class="n">org</span><span class="o">.</span><span class="n">wayround</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span>
                                    <span class="n">destdir</span> <span class="o">+</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">sep</span> <span class="o">+</span> <span class="n">i</span>
                                    <span class="p">)</span>


                                <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">islink</span><span class="p">(</span><span class="n">f_d_p</span><span class="p">):</span>
                                    <span class="n">os</span><span class="o">.</span><span class="n">chown</span><span class="p">(</span><span class="n">f_d_p</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
                                    <span class="n">os</span><span class="o">.</span><span class="n">chmod</span><span class="p">(</span><span class="n">f_d_p</span><span class="p">,</span> <span class="mi">0</span><span class="n">o755</span><span class="p">)</span>

                            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">files</span><span class="p">:</span>
                                <span class="n">f_f_p</span> <span class="o">=</span> <span class="n">org</span><span class="o">.</span><span class="n">wayround</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span>
                                    <span class="n">destdir</span> <span class="o">+</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">sep</span> <span class="o">+</span> <span class="n">i</span>
                                    <span class="p">)</span>


                                <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">islink</span><span class="p">(</span><span class="n">f_f_p</span><span class="p">):</span>
                                    <span class="n">os</span><span class="o">.</span><span class="n">chown</span><span class="p">(</span><span class="n">f_f_p</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
                                    <span class="n">os</span><span class="o">.</span><span class="n">chmod</span><span class="p">(</span><span class="n">f_f_p</span><span class="p">,</span> <span class="mi">0</span><span class="n">o755</span><span class="p">)</span>
                        <span class="k">finally</span><span class="p">:</span>
                            <span class="n">installed_file_list</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

                <span class="k">if</span> <span class="n">ret</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;Searching post installation script&quot;</span><span class="p">)</span>

                    <span class="n">script_obj</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="n">org</span><span class="o">.</span><span class="n">wayround</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">archive</span><span class="o">.</span><span class="n">tar_member_get_extract_file</span><span class="p">(</span>
                            <span class="n">tarf</span><span class="p">,</span> <span class="s">&#39;./post_install.py&#39;</span>
                            <span class="p">)</span>
                        <span class="p">)</span>

                    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">script_obj</span><span class="p">,</span> <span class="n">tarfile</span><span class="o">.</span><span class="n">ExFileObject</span><span class="p">):</span>
                        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                            <span class="s">&quot;Can&#39;t get package&#39;s post installation script&quot;</span>
                            <span class="p">)</span>

                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">script_txt</span> <span class="o">=</span> <span class="n">script_obj</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>

                            <span class="n">g</span> <span class="o">=</span> <span class="p">{}</span>
                            <span class="n">l</span> <span class="o">=</span> <span class="n">g</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="k">exec</span><span class="p">(</span>
                                    <span class="nb">compile</span><span class="p">(</span>
                                        <span class="n">script_txt</span><span class="p">,</span>
                                        <span class="bp">None</span><span class="p">,</span>
                                        <span class="s">&#39;exec&#39;</span>
                                        <span class="p">),</span>
                                    <span class="n">g</span><span class="p">,</span>
                                    <span class="n">l</span>
                                    <span class="p">)</span>
                            <span class="k">except</span><span class="p">:</span>
                                <span class="n">logging</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span>
                                    <span class="s">&quot;Can&#39;t load package&#39;s post installation script&quot;</span>
                                    <span class="p">)</span>
                                <span class="n">ret</span> <span class="o">=</span> <span class="mi">7</span>

                            <span class="k">else</span><span class="p">:</span>
                                <span class="k">if</span> <span class="n">l</span><span class="p">[</span><span class="s">&#39;main&#39;</span><span class="p">](</span><span class="n">destdir</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                                    <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                                        <span class="s">&quot;Post installation script main function returned error&quot;</span>
                                        <span class="p">)</span>
                                    <span class="n">ret</span> <span class="o">=</span> <span class="mi">8</span>
                        <span class="k">finally</span><span class="p">:</span>
                            <span class="n">script_obj</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>


            <span class="n">tarf</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">ret</span>

<span class="k">def</span> <span class="nf">remove_asp</span><span class="p">(</span>
    <span class="n">asp_name</span><span class="p">,</span></div>
<div class="viewcode-block" id="remove_asp"><a class="viewcode-back" href="../../../../package.html#org.wayround.aipsetup.package.remove_asp">[docs]</a>    <span class="n">destdir</span><span class="o">=</span><span class="s">&#39;/&#39;</span><span class="p">,</span>
    <span class="n">only_remove_package_registration</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
    <span class="n">exclude</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
    <span class="n">mute</span><span class="o">=</span><span class="bp">False</span>
    <span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Removes named asp from destdir system.</span>

<span class="sd">    :param exclude: can be ``None`` or ``list`` of files which is NOT</span>
<span class="sd">        PREPENDED WITH DESTDIR</span>

<span class="sd">    :param only_remove_package_registration: do not actually remove files from</span>
<span class="sd">        system, only remove it&#39;s registration</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">exclude</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">exclude</span><span class="p">)</span>

    <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="c"># ensure destdir correctness</span>
    <span class="n">destdir</span> <span class="o">=</span> <span class="n">org</span><span class="o">.</span><span class="n">wayround</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">destdir</span><span class="p">)</span>

    <span class="n">lines</span> <span class="o">=</span> <span class="n">list_files_installed_by_asp</span><span class="p">(</span><span class="n">destdir</span><span class="p">,</span> <span class="n">asp_name</span><span class="p">,</span> <span class="n">mute</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">lines</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
            <span class="s">&quot;Some errors while getting ASP&#39;s file list for `{}&#39;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">asp_name</span>
                <span class="p">)</span>
            <span class="p">)</span>
        <span class="n">ret</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">else</span><span class="p">:</span>

        <span class="c"># from this point we working with other systems&#39; files</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="n">org</span><span class="o">.</span><span class="n">wayround</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">prepend_path</span><span class="p">(</span><span class="n">lines</span><span class="p">,</span> <span class="n">destdir</span><span class="p">)</span>

        <span class="n">lines</span> <span class="o">=</span> <span class="n">org</span><span class="o">.</span><span class="n">wayround</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">realpaths</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span>

        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;Removing `{}&#39; files&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">asp_name</span><span class="p">))</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">only_remove_package_registration</span><span class="p">:</span>

            <span class="k">if</span> <span class="n">exclude</span><span class="p">:</span>

                <span class="c"># Some files need to be excluded from removal operation</span>

                <span class="n">lines_before_ex</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span>

                <span class="n">exclude</span> <span class="o">=</span> <span class="n">org</span><span class="o">.</span><span class="n">wayround</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">prepend_path</span><span class="p">(</span><span class="n">exclude</span><span class="p">,</span> <span class="n">destdir</span><span class="p">)</span>

                <span class="n">exclude</span> <span class="o">=</span> <span class="n">org</span><span class="o">.</span><span class="n">wayround</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">realpaths</span><span class="p">(</span><span class="n">exclude</span><span class="p">)</span>

                <span class="n">lines</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span> <span class="o">-</span> <span class="nb">set</span><span class="p">(</span><span class="n">exclude</span><span class="p">))</span>

                <span class="c"># Statistics about excluded files</span>
                <span class="n">lines_after_ex</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">lines_before_ex</span> <span class="o">!=</span> <span class="n">lines_after_ex</span><span class="p">:</span>
                    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                        <span class="s">&quot;Excluded {} new files&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                            <span class="n">lines_before_ex</span> <span class="o">-</span> <span class="n">lines_after_ex</span>
                            <span class="p">)</span>
                        <span class="p">)</span>

            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;Excluding shared objects&quot;</span><span class="p">)</span>
            <span class="n">shared_objects</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">i</span><span class="p">):</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">org</span><span class="o">.</span><span class="n">wayround</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">format</span><span class="o">.</span><span class="n">elf</span><span class="o">.</span><span class="n">get_elf_file_type</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">==</span>
                        <span class="n">org</span><span class="o">.</span><span class="n">wayround</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">format</span><span class="o">.</span><span class="n">elf</span><span class="o">.</span><span class="n">ET_DYN</span><span class="p">):</span>
                        <span class="n">shared_objects</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">exclude</span><span class="p">:</span>
                <span class="n">shared_objects</span> <span class="o">-=</span> <span class="nb">set</span><span class="p">(</span><span class="n">exclude</span><span class="p">)</span>

            <span class="n">shared_objects_tl</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">shared_objects</span><span class="p">)</span>
            <span class="n">shared_objects_tl</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>

            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">shared_objects_tl</span><span class="p">:</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;    excluded {}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>

            <span class="k">del</span><span class="p">(</span><span class="n">shared_objects_tl</span><span class="p">)</span>


            <span class="n">lines</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span> <span class="o">-</span> <span class="nb">set</span><span class="p">(</span><span class="n">shared_objects</span><span class="p">))</span>

            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="s">&quot;Excluded {} shared objects&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="nb">len</span><span class="p">(</span><span class="n">shared_objects</span><span class="p">)</span>
                    <span class="p">)</span>
                <span class="p">)</span>


            <span class="n">lines</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">reverse</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">:</span>

                <span class="n">rm_file_name</span> <span class="o">=</span> <span class="n">org</span><span class="o">.</span><span class="n">wayround</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span>
                    <span class="n">line</span>
                    <span class="p">)</span>


                <span class="k">if</span> <span class="p">(</span>
                    <span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">islink</span><span class="p">(</span><span class="n">rm_file_name</span><span class="p">)</span>
                     <span class="ow">and</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">rm_file_name</span><span class="p">)</span>
                     <span class="p">)</span>
                    <span class="ow">or</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">rm_file_name</span><span class="p">)</span>
                    <span class="ow">or</span>
                    <span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">rm_file_name</span><span class="p">)</span>
                     <span class="ow">and</span> <span class="n">org</span><span class="o">.</span><span class="n">wayround</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">file</span><span class="o">.</span><span class="n">is_dir_empty</span><span class="p">(</span><span class="n">rm_file_name</span><span class="p">)</span>
                     <span class="p">)</span>
                    <span class="p">):</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">mute</span><span class="p">:</span>
                        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;   removing: {}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">rm_file_name</span><span class="p">))</span>

                    <span class="k">if</span> <span class="p">(</span>
                        <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">rm_file_name</span><span class="p">)</span>
                        <span class="ow">or</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">islink</span><span class="p">(</span><span class="n">rm_file_name</span><span class="p">)</span>
                        <span class="p">):</span>

                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">os</span><span class="o">.</span><span class="n">unlink</span><span class="p">(</span><span class="n">rm_file_name</span><span class="p">)</span>
                        <span class="k">except</span><span class="p">:</span>
                            <span class="n">logging</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span>
                                <span class="s">&quot;Couldn&#39;t remove file: {}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">rm_file_name</span><span class="p">)</span>
                                <span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">os</span><span class="o">.</span><span class="n">rmdir</span><span class="p">(</span><span class="n">rm_file_name</span><span class="p">)</span>
                        <span class="k">except</span><span class="p">:</span>
                            <span class="n">logging</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span>
                                <span class="s">&quot;Couldn&#39;t remove dir: {}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">rm_file_name</span><span class="p">)</span>
                                <span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">shared_objects</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>

            <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="s">&quot;{} shared objects of asp `{}&#39; was remained in system&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="nb">len</span><span class="p">(</span><span class="n">shared_objects</span><span class="p">),</span> <span class="n">asp_name</span>
                    <span class="p">)</span>
                <span class="p">)</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="p">[</span>
            <span class="s">&#39;installed_pkg_dir_buildlogs&#39;</span><span class="p">,</span>
            <span class="s">&#39;installed_pkg_dir_sums&#39;</span><span class="p">,</span>
            <span class="s">&#39;installed_pkg_dir&#39;</span>
            <span class="p">]:</span>
            <span class="n">rm_file_name</span> <span class="o">=</span> <span class="n">org</span><span class="o">.</span><span class="n">wayround</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span>
                <span class="n">destdir</span> <span class="o">+</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">sep</span> <span class="o">+</span>
                <span class="n">org</span><span class="o">.</span><span class="n">wayround</span><span class="o">.</span><span class="n">aipsetup</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">sep</span> <span class="o">+</span>
                <span class="n">asp_name</span> <span class="o">+</span> <span class="s">&#39;.xz&#39;</span>
                <span class="p">)</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">rm_file_name</span><span class="p">):</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;   removing: {}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">rm_file_name</span><span class="p">))</span>
                <span class="n">os</span><span class="o">.</span><span class="n">unlink</span><span class="p">(</span><span class="n">rm_file_name</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">ret</span>

<span class="k">def</span> <span class="nf">reduce_asps</span><span class="p">(</span><span class="n">reduce_to</span><span class="p">,</span> <span class="n">reduce_what</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">destdir</span><span class="o">=</span><span class="s">&#39;/&#39;</span><span class="p">,</span> <span class="n">mute</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
</div>
<div class="viewcode-block" id="reduce_asps"><a class="viewcode-back" href="../../../../package.html#org.wayround.aipsetup.package.reduce_asps">[docs]</a>    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Reduces(removes) packages listed in ``reduce_what`` list, remaining all</span>
<span class="sd">    files belonging to package named in ``reduce_to`` string parameter</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">reduce_what</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;reduce_what must be a list of strings&quot;</span><span class="p">)</span>

    <span class="n">reduce_to</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">reduce_to</span><span class="p">)</span>

    <span class="n">reduce_to</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">org</span><span class="o">.</span><span class="n">wayround</span><span class="o">.</span><span class="n">aipsetup</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">rm_ext_from_pkg_name</span><span class="p">(</span><span class="n">reduce_to</span><span class="p">)</span>
        <span class="p">)</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">reduce_what</span><span class="p">)):</span>
        <span class="n">reduce_what</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">reduce_what</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
        <span class="n">reduce_what</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">org</span><span class="o">.</span><span class="n">wayround</span><span class="o">.</span><span class="n">aipsetup</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">rm_ext_from_pkg_name</span><span class="p">(</span>
                <span class="n">reduce_what</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="p">)</span>
            <span class="p">)</span>

    <span class="k">if</span> <span class="n">reduce_to</span> <span class="ow">in</span> <span class="n">reduce_what</span><span class="p">:</span>
        <span class="n">reduce_what</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">reduce_to</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">destdir</span> <span class="o">!=</span> <span class="s">&#39;/&#39;</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">mute</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;Destdir: {}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">destdir</span><span class="p">))</span>

    <span class="n">fiba</span> <span class="o">=</span> <span class="n">list_files_installed_by_asp</span><span class="p">(</span><span class="n">destdir</span><span class="p">,</span> <span class="n">reduce_to</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">fiba</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
            <span class="s">&quot;Some error getting list of files installed by {}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">reduce_to</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="n">ret</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">else</span><span class="p">:</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">reduce_what</span><span class="p">:</span>
            <span class="n">remove_asp</span><span class="p">(</span>
                <span class="n">i</span><span class="p">,</span>
                <span class="n">destdir</span><span class="p">,</span>
                <span class="n">exclude</span><span class="o">=</span><span class="n">fiba</span>
                <span class="p">)</span>

    <span class="k">return</span> <span class="n">ret</span>


<span class="k">def</span> <span class="nf">list_installed_asps</span><span class="p">(</span><span class="n">destdir</span><span class="o">=</span><span class="s">&#39;/&#39;</span><span class="p">,</span> <span class="n">mute</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
</div>
<div class="viewcode-block" id="list_installed_asps"><a class="viewcode-back" href="../../../../package.html#org.wayround.aipsetup.package.list_installed_asps">[docs]</a>    <span class="n">destdir</span> <span class="o">=</span> <span class="n">org</span><span class="o">.</span><span class="n">wayround</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">destdir</span><span class="p">)</span>

    <span class="n">listdir</span> <span class="o">=</span> <span class="n">org</span><span class="o">.</span><span class="n">wayround</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span>
        <span class="n">destdir</span> <span class="o">+</span> <span class="n">org</span><span class="o">.</span><span class="n">wayround</span><span class="o">.</span><span class="n">aipsetup</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&#39;installed_pkg_dir&#39;</span><span class="p">]</span>
        <span class="p">)</span>

    <span class="n">filelist</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">listdir</span><span class="p">,</span> <span class="s">&#39;*.xz&#39;</span><span class="p">))</span>

    <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">listdir</span><span class="p">):</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&quot;not a dir {}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">listdir</span><span class="p">))</span>
        <span class="n">ret</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">else</span><span class="p">:</span>

        <span class="n">bases</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">each</span> <span class="ow">in</span> <span class="n">filelist</span><span class="p">:</span>
            <span class="n">bases</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">each</span><span class="p">))</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="p">[</span><span class="s">&#39;sums&#39;</span><span class="p">,</span> <span class="s">&#39;buildlogs&#39;</span><span class="p">,</span> <span class="s">&#39;.&#39;</span><span class="p">,</span> <span class="s">&#39;..&#39;</span><span class="p">]:</span>
            <span class="k">if</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">bases</span><span class="p">:</span>
                <span class="n">bases</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>

        <span class="n">ret</span> <span class="o">=</span> <span class="n">bases</span>

    <span class="k">return</span> <span class="n">ret</span>


<span class="k">def</span> <span class="nf">list_installed_packages</span><span class="p">(</span><span class="n">mask</span><span class="o">=</span><span class="s">&#39;*&#39;</span><span class="p">,</span> <span class="n">destdir</span><span class="o">=</span><span class="s">&#39;/&#39;</span><span class="p">,</span> <span class="n">mute</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
</div>
<div class="viewcode-block" id="list_installed_packages"><a class="viewcode-back" href="../../../../package.html#org.wayround.aipsetup.package.list_installed_packages">[docs]</a>    <span class="n">ret</span> <span class="o">=</span> <span class="bp">None</span>

    <span class="n">asps</span> <span class="o">=</span> <span class="n">list_installed_asps</span><span class="p">(</span><span class="n">destdir</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">asps</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&quot;Error getting list of installed ASPs&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">lst</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">asps</span><span class="p">:</span>
            <span class="n">parsed</span> <span class="o">=</span> <span class="n">org</span><span class="o">.</span><span class="n">wayround</span><span class="o">.</span><span class="n">aipsetup</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">package_name_parse</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">mute</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">parsed</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&quot;Couldn&#39;t parse name `{}&#39;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">name</span> <span class="o">=</span> <span class="n">parsed</span><span class="p">[</span><span class="s">&#39;groups&#39;</span><span class="p">][</span><span class="s">&#39;name&#39;</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">fnmatch</span><span class="o">.</span><span class="n">fnmatch</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">mask</span><span class="p">):</span>
                    <span class="n">lst</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>

        <span class="n">lst</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">lst</span><span class="p">)</span>
        <span class="n">lst</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>

        <span class="n">ret</span> <span class="o">=</span> <span class="n">lst</span>

    <span class="k">return</span> <span class="n">ret</span>

<span class="k">def</span> <span class="nf">latest_installed_package_s_asp</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">destdir</span><span class="o">=</span><span class="s">&#39;/&#39;</span><span class="p">):</span>
</div>
<div class="viewcode-block" id="latest_installed_package_s_asp"><a class="viewcode-back" href="../../../../package.html#org.wayround.aipsetup.package.latest_installed_package_s_asp">[docs]</a>    <span class="n">lst</span> <span class="o">=</span> <span class="n">list_installed_package_s_asps</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">destdir</span><span class="p">)</span>

    <span class="n">ret</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">lst</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">latest</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span>
            <span class="n">lst</span><span class="p">,</span>
            <span class="n">key</span><span class="o">=</span><span class="n">functools</span><span class="o">.</span><span class="n">cmp_to_key</span><span class="p">(</span>
                <span class="n">org</span><span class="o">.</span><span class="n">wayround</span><span class="o">.</span><span class="n">aipsetup</span><span class="o">.</span><span class="n">version</span><span class="o">.</span><span class="n">package_version_comparator</span>
                <span class="p">)</span>
            <span class="p">)</span>

        <span class="n">ret</span> <span class="o">=</span> <span class="n">latest</span>

    <span class="k">return</span> <span class="n">ret</span>

<span class="k">def</span> <span class="nf">list_installed_package_s_asps</span><span class="p">(</span><span class="n">name_or_list</span><span class="p">,</span> <span class="n">destdir</span><span class="o">=</span><span class="s">&#39;/&#39;</span><span class="p">):</span>
</div>
<div class="viewcode-block" id="list_installed_package_s_asps"><a class="viewcode-back" href="../../../../package.html#org.wayround.aipsetup.package.list_installed_package_s_asps">[docs]</a>    <span class="n">ret</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="n">return_single</span> <span class="o">=</span> <span class="bp">False</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">name_or_list</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">return_single</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="n">name_or_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">name_or_list</span><span class="p">]</span>

    <span class="n">asps_list</span> <span class="o">=</span> <span class="n">list_installed_asps</span><span class="p">(</span><span class="n">destdir</span><span class="o">=</span><span class="n">destdir</span><span class="p">,</span> <span class="n">mute</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">asps_list_parsed</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">asps_list</span><span class="p">:</span>
        <span class="n">asps_list_parsed</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">org</span><span class="o">.</span><span class="n">wayround</span><span class="o">.</span><span class="n">aipsetup</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">package_name_parse</span><span class="p">(</span>
            <span class="n">i</span><span class="p">,</span>
            <span class="n">mute</span><span class="o">=</span><span class="bp">True</span>
            <span class="p">)</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">name_or_list</span><span class="p">:</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">ret</span><span class="p">:</span>
            <span class="n">ret</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">asps_list</span><span class="p">:</span>

            <span class="k">if</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">asps_list_parsed</span><span class="p">[</span><span class="n">j</span><span class="p">],</span> <span class="nb">dict</span><span class="p">)</span>
                <span class="ow">and</span> <span class="n">asps_list_parsed</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="s">&#39;groups&#39;</span><span class="p">][</span><span class="s">&#39;name&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">i</span><span class="p">):</span>

                <span class="n">ret</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">j</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">return_single</span><span class="p">:</span>
        <span class="n">ret</span> <span class="o">=</span> <span class="n">ret</span><span class="p">[</span><span class="n">name_or_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>

    <span class="k">return</span> <span class="n">ret</span>

<span class="k">def</span> <span class="nf">list_files_installed_by_asp</span><span class="p">(</span>
    <span class="n">destdir</span><span class="p">,</span> <span class="n">asp_name</span><span class="p">,</span> <span class="n">mute</span><span class="o">=</span><span class="bp">True</span></div>
<div class="viewcode-block" id="list_files_installed_by_asp"><a class="viewcode-back" href="../../../../package.html#org.wayround.aipsetup.package.list_files_installed_by_asp">[docs]</a>    <span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Reads list of files installed by named asp.</span>

<span class="sd">    Destdir is not prependet to the list&#39;s items. Do it yuorself if needed.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="n">destdir</span> <span class="o">=</span> <span class="n">org</span><span class="o">.</span><span class="n">wayround</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">destdir</span><span class="p">)</span>

    <span class="n">list_dir</span> <span class="o">=</span> <span class="n">org</span><span class="o">.</span><span class="n">wayround</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span>
        <span class="n">destdir</span> <span class="o">+</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">sep</span> <span class="o">+</span>
        <span class="n">org</span><span class="o">.</span><span class="n">wayround</span><span class="o">.</span><span class="n">aipsetup</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&#39;installed_pkg_dir&#39;</span><span class="p">]</span>
        <span class="p">)</span>

    <span class="n">pkg_list_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">list_dir</span><span class="p">,</span> <span class="n">asp_name</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">pkg_list_file</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s">&#39;.xz&#39;</span><span class="p">):</span>
        <span class="n">pkg_list_file</span> <span class="o">+=</span> <span class="s">&#39;.xz&#39;</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">pkg_list_file</span><span class="p">,</span> <span class="s">&#39;rb&#39;</span><span class="p">)</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s">&quot;Can&#39;t open list file `{}&#39;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">pkg_list_file</span><span class="p">))</span>
        <span class="n">ret</span> <span class="o">=</span> <span class="mi">2</span>
    <span class="k">else</span><span class="p">:</span>

        <span class="n">pkg_file_list</span> <span class="o">=</span> <span class="n">org</span><span class="o">.</span><span class="n">wayround</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">archive</span><span class="o">.</span><span class="n">xzcat</span><span class="p">(</span>
            <span class="n">f</span><span class="p">,</span> <span class="n">convert_to_str</span><span class="o">=</span><span class="bp">True</span>
            <span class="p">)</span>

        <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="n">pkg_file_list</span> <span class="o">=</span> <span class="n">pkg_file_list</span><span class="o">.</span><span class="n">splitlines</span><span class="p">()</span>
        <span class="n">pkg_file_list</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">org</span><span class="o">.</span><span class="n">wayround</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">list</span><span class="o">.</span><span class="n">filelist_strip_remove_empty_remove_duplicated_lines</span><span class="p">(</span>
                <span class="n">pkg_file_list</span>
                <span class="p">)</span>
            <span class="p">)</span>


        <span class="n">pkg_file_list</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>

        <span class="n">ret</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">pkg_file_list</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">ret</span>



<span class="k">def</span> <span class="nf">list_installed_packages_and_asps</span><span class="p">(</span><span class="n">destdir</span><span class="o">=</span><span class="s">&#39;/&#39;</span><span class="p">):</span>
</div>
<div class="viewcode-block" id="list_installed_packages_and_asps"><a class="viewcode-back" href="../../../../package.html#org.wayround.aipsetup.package.list_installed_packages_and_asps">[docs]</a>    <span class="n">packages</span> <span class="o">=</span> <span class="n">list_installed_packages</span><span class="p">(</span><span class="n">mute</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">destdir</span><span class="o">=</span><span class="n">destdir</span><span class="p">)</span>

    <span class="n">ret</span> <span class="o">=</span> <span class="n">list_installed_package_s_asps</span><span class="p">(</span><span class="n">packages</span><span class="p">,</span> <span class="n">destdir</span><span class="o">=</span><span class="n">destdir</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">ret</span>

<span class="k">def</span> <span class="nf">list_installed_asps_and_their_files</span><span class="p">(</span><span class="n">destdir</span><span class="o">=</span><span class="s">&#39;/&#39;</span><span class="p">,</span> <span class="n">mute</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
</div>
<div class="viewcode-block" id="list_installed_asps_and_their_files"><a class="viewcode-back" href="../../../../package.html#org.wayround.aipsetup.package.list_installed_asps_and_their_files">[docs]</a>    <span class="n">lst</span> <span class="o">=</span> <span class="n">list_installed_asps</span><span class="p">(</span><span class="n">destdir</span><span class="p">,</span> <span class="n">mute</span><span class="p">)</span>

    <span class="n">ret</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">lst</span><span class="p">:</span>
        <span class="n">ret</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">list_files_installed_by_asp</span><span class="p">(</span><span class="n">destdir</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">mute</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">ret</span>


<span class="k">def</span> <span class="nf">build</span><span class="p">(</span><span class="n">source_files</span><span class="p">,</span> <span class="n">remove_buildingsite_after_success</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span></div>
<div class="viewcode-block" id="build"><a class="viewcode-back" href="../../../../package.html#org.wayround.aipsetup.package.build">[docs]</a><span class="sd">    Gathering function for all package building process</span>

<span class="sd">    Uses :func:`org.wayround.aipsetup.buildingsite.init` to create building site.</span>
<span class="sd">    Farther process controlled by :func:`complete`.</span>

<span class="sd">    :param source_files: tarball name or list of them.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="n">par_res</span> <span class="o">=</span> <span class="n">org</span><span class="o">.</span><span class="n">wayround</span><span class="o">.</span><span class="n">aipsetup</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">source_name_parse</span><span class="p">(</span>
        <span class="n">source_files</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
        <span class="n">mute</span><span class="o">=</span><span class="bp">True</span>
        <span class="p">)</span>


    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">par_res</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&quot;Can&#39;t parse source file name&quot;</span><span class="p">)</span>
        <span class="n">ret</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">else</span><span class="p">:</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">org</span><span class="o">.</span><span class="n">wayround</span><span class="o">.</span><span class="n">aipsetup</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&#39;buildingsites&#39;</span><span class="p">])</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">pass</span>

        <span class="n">package_info</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">org</span><span class="o">.</span><span class="n">wayround</span><span class="o">.</span><span class="n">aipsetup</span><span class="o">.</span><span class="n">pkginfo</span><span class="o">.</span><span class="n">get_info_rec_by_tarball_filename</span><span class="p">(</span>
                <span class="n">source_files</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="p">)</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">package_info</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                <span class="s">&quot;Can&#39;t find package information for tarball `{}&#39;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">source_files</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="p">)</span>
                <span class="p">)</span>
            <span class="n">ret</span> <span class="o">=</span> <span class="mi">2</span>
        <span class="k">else</span><span class="p">:</span>

            <span class="n">tmp_dir_prefix</span> <span class="o">=</span> <span class="s">&quot;{name}-{version}-{status}-{timestamp}-&quot;</span><span class="o">.</span><span class="n">format_map</span><span class="p">(</span>
                <span class="p">{</span>
                    <span class="s">&#39;name&#39;</span><span class="p">:</span> <span class="n">package_info</span><span class="p">[</span><span class="s">&#39;name&#39;</span><span class="p">],</span>
                    <span class="s">&#39;version&#39;</span><span class="p">:</span> <span class="n">par_res</span><span class="p">[</span><span class="s">&#39;groups&#39;</span><span class="p">][</span><span class="s">&#39;version&#39;</span><span class="p">],</span>
                    <span class="s">&#39;status&#39;</span><span class="p">:</span> <span class="n">par_res</span><span class="p">[</span><span class="s">&#39;groups&#39;</span><span class="p">][</span><span class="s">&#39;status&#39;</span><span class="p">],</span>
                    <span class="s">&#39;timestamp&#39;</span><span class="p">:</span> <span class="n">org</span><span class="o">.</span><span class="n">wayround</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">time</span><span class="o">.</span><span class="n">currenttime_stamp</span><span class="p">()</span>
                    <span class="p">}</span>
                <span class="p">)</span>

            <span class="n">build_site_dir</span> <span class="o">=</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">mkdtemp</span><span class="p">(</span>
                <span class="n">prefix</span><span class="o">=</span><span class="n">tmp_dir_prefix</span><span class="p">,</span>
                <span class="nb">dir</span><span class="o">=</span><span class="n">org</span><span class="o">.</span><span class="n">wayround</span><span class="o">.</span><span class="n">aipsetup</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&#39;buildingsites&#39;</span><span class="p">]</span>
                <span class="p">)</span>

            <span class="n">build_site_dir</span> <span class="o">=</span> <span class="n">org</span><span class="o">.</span><span class="n">wayround</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">build_site_dir</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">org</span><span class="o">.</span><span class="n">wayround</span><span class="o">.</span><span class="n">aipsetup</span><span class="o">.</span><span class="n">buildingsite</span><span class="o">.</span><span class="n">init</span><span class="p">(</span><span class="n">build_site_dir</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&quot;Error initiating temporary dir&quot;</span><span class="p">)</span>
                <span class="n">ret</span> <span class="o">=</span> <span class="mi">3</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">source_files</span> <span class="o">!=</span> <span class="bp">None</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">source_files</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>

                    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;Copying sources...&quot;</span><span class="p">)</span>

                    <span class="k">for</span> <span class="n">source_file</span> <span class="ow">in</span> <span class="n">source_files</span><span class="p">:</span>

                        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;    {}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">source_file</span><span class="p">))</span>

                        <span class="k">if</span> <span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">source_file</span><span class="p">)</span>
                            <span class="ow">and</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">islink</span><span class="p">(</span><span class="n">source_file</span><span class="p">)):</span>

                            <span class="k">try</span><span class="p">:</span>
                                <span class="n">shutil</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span>
                                    <span class="n">source_file</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                                        <span class="n">build_site_dir</span><span class="p">,</span>
                                        <span class="n">org</span><span class="o">.</span><span class="n">wayround</span><span class="o">.</span><span class="n">aipsetup</span><span class="o">.</span><span class="n">buildingsite</span><span class="o">.</span><span class="n">DIR_TARBALL</span>
                                        <span class="p">)</span>
                                    <span class="p">)</span>
                            <span class="k">except</span><span class="p">:</span>
                                <span class="n">logging</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s">&quot;Couldn&#39;t copy source file&quot;</span><span class="p">)</span>
                                <span class="n">ret</span> <span class="o">=</span> <span class="mi">4</span>

                        <span class="k">else</span><span class="p">:</span>

                            <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                                <span class="s">&quot;file {} - not dir and not file. skipping copy&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                                    <span class="n">source_file</span>
                                    <span class="p">)</span>
                                <span class="p">)</span>

                    <span class="k">if</span> <span class="n">ret</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                            <span class="s">&quot;Exception while copying one of source files&quot;</span>
                            <span class="p">)</span>

                <span class="k">if</span> <span class="n">ret</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>

                    <span class="c"># FIXME: rework this</span>
                    <span class="k">if</span> <span class="n">complete</span><span class="p">(</span>
                        <span class="n">build_site_dir</span><span class="p">,</span>
                        <span class="n">source_files</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                        <span class="n">remove_buildingsite_after_success</span><span class="o">=</span><span class="n">remove_buildingsite_after_success</span>
                        <span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>

                        <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&quot;Package building failed&quot;</span><span class="p">)</span>
                        <span class="n">ret</span> <span class="o">=</span> <span class="mi">5</span>

    <span class="k">return</span> <span class="n">ret</span>

<span class="k">def</span> <span class="nf">_complete_info_correctness_check</span><span class="p">(</span><span class="n">workdir</span><span class="p">):</span>
</div>
<div class="viewcode-block" id="_complete_info_correctness_check"><a class="viewcode-back" href="../../../../package.html#org.wayround.aipsetup.package._complete_info_correctness_check">[docs]</a>    <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="n">r</span> <span class="o">=</span> <span class="n">org</span><span class="o">.</span><span class="n">wayround</span><span class="o">.</span><span class="n">aipsetup</span><span class="o">.</span><span class="n">buildingsite</span><span class="o">.</span><span class="n">read_package_info</span><span class="p">(</span>
        <span class="n">workdir</span><span class="p">,</span> <span class="p">{}</span>
        <span class="p">)</span>

    <span class="n">scr_name</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">scr_name</span> <span class="o">=</span> <span class="n">r</span><span class="p">[</span><span class="s">&#39;pkg_info&#39;</span><span class="p">][</span><span class="s">&#39;buildscript&#39;</span><span class="p">]</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">scr_name</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>

    <span class="k">if</span> <span class="p">(</span>
        <span class="n">scr_name</span> <span class="o">==</span> <span class="s">&#39;&#39;</span>
        <span class="ow">or</span>
        <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span>
            <span class="n">org</span><span class="o">.</span><span class="n">wayround</span><span class="o">.</span><span class="n">aipsetup</span><span class="o">.</span><span class="n">buildscript</span><span class="o">.</span><span class="n">load_buildscript</span><span class="p">(</span>
                <span class="n">scr_name</span>
                <span class="p">),</span>
            <span class="nb">dict</span>
            <span class="p">)</span>
        <span class="p">):</span>
        <span class="n">ret</span> <span class="o">=</span> <span class="mi">1</span>

    <span class="k">return</span> <span class="n">ret</span>

<span class="k">def</span> <span class="nf">complete</span><span class="p">(</span>
    <span class="n">building_site</span><span class="p">,</span></div>
<div class="viewcode-block" id="complete"><a class="viewcode-back" href="../../../../package.html#org.wayround.aipsetup.package.complete">[docs]</a>    <span class="n">main_src_file</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
    <span class="n">remove_buildingsite_after_success</span><span class="o">=</span><span class="bp">False</span>
    <span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Applies package information on building site, does building and packaging</span>
<span class="sd">    and optionally deletes building site after everything is done.</span>

<span class="sd">    :param main_src_file: used with function</span>
<span class="sd">        :func:`buildingsite.apply_info &lt;org.wayround.aipsetup.buildingsite.apply_info&gt;`</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">rp</span> <span class="o">=</span> <span class="n">org</span><span class="o">.</span><span class="n">wayround</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">relpath</span><span class="p">(</span><span class="n">building_site</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">())</span>

    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
        <span class="s">&quot;+++++++++++ Starting Complete build in `{}&#39; +++++++++++&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">rp</span><span class="p">)</span>
        <span class="p">)</span>

    <span class="n">building_site</span> <span class="o">=</span> <span class="n">org</span><span class="o">.</span><span class="n">wayround</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">building_site</span><span class="p">)</span>

    <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">_complete_info_correctness_check</span><span class="p">(</span><span class="n">building_site</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span>
        <span class="ow">or</span>
        <span class="nb">isinstance</span><span class="p">(</span><span class="n">main_src_file</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span>
        <span class="p">):</span>

        <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
            <span class="s">&quot;buildscript information not available &quot;</span>
            <span class="s">&quot;(or new main tarball file forced)&quot;</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="n">org</span><span class="o">.</span><span class="n">wayround</span><span class="o">.</span><span class="n">aipsetup</span><span class="o">.</span><span class="n">buildingsite</span><span class="o">.</span><span class="n">apply_info</span><span class="p">(</span>
            <span class="n">building_site</span><span class="p">,</span>
            <span class="n">main_src_file</span>
            <span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span> <span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&quot;Can&#39;t apply build information to site&quot;</span><span class="p">)</span>
            <span class="n">ret</span> <span class="o">=</span> <span class="mi">15</span>

    <span class="k">if</span> <span class="n">ret</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">_complete_info_correctness_check</span><span class="p">(</span><span class="n">building_site</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>

            <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                <span class="s">&quot;`{}&#39; has wrong build script name&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">main_src_file</span><span class="p">)</span>
                <span class="p">)</span>
            <span class="n">ret</span> <span class="o">=</span> <span class="mi">16</span>

    <span class="k">if</span> <span class="n">ret</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>

        <span class="n">log</span> <span class="o">=</span> <span class="n">org</span><span class="o">.</span><span class="n">wayround</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">Log</span><span class="p">(</span>
            <span class="n">org</span><span class="o">.</span><span class="n">wayround</span><span class="o">.</span><span class="n">aipsetup</span><span class="o">.</span><span class="n">buildingsite</span><span class="o">.</span><span class="n">getDIR_BUILD_LOGS</span><span class="p">(</span><span class="n">building_site</span><span class="p">),</span>
            <span class="s">&#39;buildingsite complete&#39;</span>
            <span class="p">)</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;Buildingsite processes started&quot;</span><span class="p">)</span>
        <span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s">&quot;Closing this log now, cause it can&#39;t work farther&quot;</span><span class="p">)</span>
        <span class="n">log</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">org</span><span class="o">.</span><span class="n">wayround</span><span class="o">.</span><span class="n">aipsetup</span><span class="o">.</span><span class="n">build</span><span class="o">.</span><span class="n">complete</span><span class="p">(</span><span class="n">building_site</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&quot;Error on building stage&quot;</span><span class="p">)</span>
            <span class="n">ret</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">elif</span> <span class="n">org</span><span class="o">.</span><span class="n">wayround</span><span class="o">.</span><span class="n">aipsetup</span><span class="o">.</span><span class="n">pack</span><span class="o">.</span><span class="n">complete</span><span class="p">(</span><span class="n">building_site</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&quot;Error on packaging stage&quot;</span><span class="p">)</span>
            <span class="n">ret</span> <span class="o">=</span> <span class="mi">2</span>

    <span class="k">if</span> <span class="n">ret</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">remove_buildingsite_after_success</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;Removing buildingsite after successful build&quot;</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">building_site</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s">&quot;Could not remove `{}&#39;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">building_site</span><span class="p">))</span>

    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
        <span class="s">&quot;+++++++++++ Finished Complete build in `{}&#39; +++++++++++&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">rp</span><span class="p">)</span>
        <span class="p">)</span>

    <span class="k">return</span> <span class="n">ret</span>

<span class="k">def</span> <span class="nf">find_file_in_files_installed_by_asps</span><span class="p">(</span>
    <span class="n">destdir</span><span class="p">,</span></div>
<div class="viewcode-block" id="find_file_in_files_installed_by_asps"><a class="viewcode-back" href="../../../../package.html#org.wayround.aipsetup.package.find_file_in_files_installed_by_asps">[docs]</a>    <span class="n">instr</span><span class="p">,</span>
    <span class="n">mode</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
    <span class="n">mute</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
    <span class="n">sub_mute</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
    <span class="n">predefined_asp_tree</span><span class="o">=</span><span class="bp">None</span>
    <span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    instr can be a single query or list of queries.</span>

<span class="sd">    :param mode: see in :func:`find_file_in_files_installed_by_asp`</span>
<span class="sd">    :param sub_mute: passed to :func:`find_file_in_files_installed_by_asp`</span>

<span class="sd">    :param predefined_asp_tree: if this paramter passed, use it instead of</span>
<span class="sd">        manually creating it</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="n">lst</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="n">predefined_asp_tree</span><span class="p">:</span>
        <span class="n">lst</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">predefined_asp_tree</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">lst</span> <span class="o">=</span> <span class="n">list_installed_asps</span><span class="p">(</span>
            <span class="n">destdir</span><span class="o">=</span><span class="n">destdir</span><span class="p">,</span>
            <span class="n">mute</span><span class="o">=</span><span class="bp">True</span>
            <span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">lst</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&quot;Error getting installed packages list&quot;</span><span class="p">)</span>
        <span class="n">ret</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">lst</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>

        <span class="n">ret_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>

        <span class="n">lst_l</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">lst</span><span class="p">)</span>
        <span class="n">lst_i</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">for</span> <span class="n">pkgname</span> <span class="ow">in</span> <span class="n">lst</span><span class="p">:</span>

            <span class="k">if</span> <span class="n">pkgname</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s">&#39;.xz&#39;</span><span class="p">):</span>
                <span class="n">pkgname</span> <span class="o">=</span> <span class="n">pkgname</span><span class="p">[:</span><span class="o">-</span><span class="mi">3</span><span class="p">]</span>

            <span class="n">predefined_file_list</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="k">if</span> <span class="n">predefined_asp_tree</span><span class="p">:</span>
                <span class="n">predefined_file_list</span> <span class="o">=</span> <span class="n">predefined_asp_tree</span><span class="p">[</span><span class="n">pkgname</span> <span class="o">+</span> <span class="s">&#39;.xz&#39;</span><span class="p">]</span>

            <span class="n">found</span> <span class="o">=</span> <span class="n">find_file_in_files_installed_by_asp</span><span class="p">(</span>
                <span class="n">destdir</span><span class="p">,</span> <span class="n">pkgname</span><span class="p">,</span> <span class="n">instr</span><span class="o">=</span><span class="n">instr</span><span class="p">,</span>
                <span class="n">mode</span><span class="o">=</span><span class="n">mode</span><span class="p">,</span>
                <span class="n">mute</span><span class="o">=</span><span class="n">sub_mute</span><span class="p">,</span>
                <span class="n">predefined_file_list</span><span class="o">=</span><span class="n">predefined_file_list</span>
                <span class="p">)</span>

            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">found</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">ret_dict</span><span class="p">[</span><span class="n">pkgname</span><span class="p">]</span> <span class="o">=</span> <span class="n">found</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">mute</span><span class="p">:</span>

                <span class="n">lst_i</span> <span class="o">+=</span> <span class="mi">1</span>

                <span class="n">perc</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">if</span> <span class="n">lst_i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">perc</span> <span class="o">=</span> <span class="mf">0.0</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">perc</span> <span class="o">=</span> <span class="mf">100.0</span> <span class="o">/</span> <span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">lst_l</span><span class="p">)</span> <span class="o">/</span> <span class="nb">float</span><span class="p">(</span><span class="n">lst_i</span><span class="p">))</span>

                <span class="n">org</span><span class="o">.</span><span class="n">wayround</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">file</span><span class="o">.</span><span class="n">progress_write</span><span class="p">(</span>
                    <span class="s">&quot;    {:6.2f}% (found {} packages) ({})&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="n">perc</span><span class="p">,</span>
                        <span class="nb">len</span><span class="p">(</span><span class="n">ret_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">()),</span>
                        <span class="n">pkgname</span>
                        <span class="p">)</span>
                    <span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">mute</span><span class="p">:</span>
            <span class="n">org</span><span class="o">.</span><span class="n">wayround</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">file</span><span class="o">.</span><span class="n">progress_write_finish</span><span class="p">()</span>

        <span class="n">ret</span> <span class="o">=</span> <span class="n">ret_dict</span>

    <span class="k">return</span> <span class="n">ret</span>

<span class="k">def</span> <span class="nf">find_file_in_files_installed_by_asp</span><span class="p">(</span>
    <span class="n">destdir</span><span class="p">,</span> <span class="n">pkgname</span><span class="p">,</span> <span class="n">instr</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">mute</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">predefined_file_list</span><span class="o">=</span><span class="bp">None</span></div>
<div class="viewcode-block" id="find_file_in_files_installed_by_asp"><a class="viewcode-back" href="../../../../package.html#org.wayround.aipsetup.package.find_file_in_files_installed_by_asp">[docs]</a>    <span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    instr can be a single query or list of queries.</span>

<span class="sd">    ===== ======================================</span>
<span class="sd">    name  meaning</span>
<span class="sd">    ===== ======================================</span>
<span class="sd">    re    instr is or list of regular expresions</span>
<span class="sd">    plain instr is or list of plain texts</span>
<span class="sd">    sub   instr is or list of substrings</span>
<span class="sd">    beg   instr is or list of beginnings</span>
<span class="sd">    fm    instr is or list of file masks</span>
<span class="sd">    end   instr is or list of endings</span>
<span class="sd">    ===== ======================================</span>

<span class="sd">    :param instr: data which function must look for</span>
<span class="sd">    :param mode: mode inf which function must operate:</span>
<span class="sd">    :param predefined_file_list: use existing file list instead of creating own</span>
<span class="sd">    :param pkgname: take file list from this asp package</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="n">destdir</span> <span class="o">=</span> <span class="n">org</span><span class="o">.</span><span class="n">wayround</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">destdir</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">instr</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
        <span class="n">instr</span> <span class="o">=</span> <span class="p">[</span><span class="n">instr</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">mode</span> <span class="o">=</span> <span class="s">&#39;sub&#39;</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">mode</span> <span class="ow">in</span> <span class="p">[</span><span class="s">&#39;re&#39;</span><span class="p">,</span> <span class="s">&#39;plain&#39;</span><span class="p">,</span> <span class="s">&#39;sub&#39;</span><span class="p">,</span> <span class="s">&#39;beg&#39;</span><span class="p">,</span> <span class="s">&#39;fm&#39;</span><span class="p">,</span> <span class="s">&#39;end&#39;</span><span class="p">]:</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&quot;wrong mode&quot;</span><span class="p">)</span>
        <span class="n">ret</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">else</span><span class="p">:</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">pkgname</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s">&#39;.xz&#39;</span><span class="p">):</span>
            <span class="n">pkgname</span> <span class="o">+=</span> <span class="s">&#39;.xz&#39;</span>

        <span class="n">pkg_file_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">predefined_file_list</span><span class="p">:</span>
            <span class="n">pkg_file_list</span> <span class="o">=</span> <span class="n">predefined_file_list</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">pkg_file_list</span> <span class="o">=</span> <span class="n">list_files_installed_by_asp</span><span class="p">(</span>
                <span class="n">destdir</span><span class="p">,</span> <span class="n">pkgname</span>
                <span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">pkg_file_list</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&quot;Can&#39;t get list of files&quot;</span><span class="p">)</span>
            <span class="n">ret</span> <span class="o">=</span> <span class="mi">2</span>
        <span class="k">else</span><span class="p">:</span>

            <span class="n">pkg_file_list</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>

            <span class="n">out_list</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">pkg_file_list</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="s">&#39;re&#39;</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">instr</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">j</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="o">!=</span> <span class="bp">None</span><span class="p">:</span>
                            <span class="n">out_list</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>

                <span class="k">elif</span> <span class="n">mode</span> <span class="o">==</span> <span class="s">&#39;plain&#39;</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">instr</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">j</span> <span class="o">==</span> <span class="n">i</span><span class="p">:</span>
                            <span class="n">out_list</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>

                <span class="k">elif</span> <span class="n">mode</span> <span class="o">==</span> <span class="s">&#39;sub&#39;</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">instr</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">i</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">j</span><span class="p">)</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                            <span class="n">out_list</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>

                <span class="k">elif</span> <span class="n">mode</span> <span class="o">==</span> <span class="s">&#39;beg&#39;</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">instr</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">i</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">j</span><span class="p">):</span>
                            <span class="n">out_list</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>

                <span class="k">elif</span> <span class="n">mode</span> <span class="o">==</span> <span class="s">&#39;end&#39;</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">instr</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">i</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="n">j</span><span class="p">):</span>
                            <span class="n">out_list</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>

                <span class="k">elif</span> <span class="n">mode</span> <span class="o">==</span> <span class="s">&#39;fm&#39;</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">instr</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">fnmatch</span><span class="o">.</span><span class="n">fnmatch</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">):</span>
                            <span class="n">out_list</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>

            <span class="n">out_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">out_list</span><span class="p">)</span>
            <span class="n">out_list</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>

            <span class="n">ret</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">out_list</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">ret</span>
</pre></div></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="../../../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="../../../../index.html">aipsetup 3 documentation</a> &raquo;</li>
          <li><a href="../../../index.html" >Module code</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2013, AnimusPEXUS.
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.1.3.
    </div>
  </body>
</html>