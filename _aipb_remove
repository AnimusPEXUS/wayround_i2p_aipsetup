#!/bin/bash

#set -x

if [ ! -d "$AIP_DIR" ]
then
    echo " SORRY: please, install aipsetup (if not yet),"
    echo "        and run this from main program (aipsetup)"
    echo " ERROR: AIP_DIR not set"
    exit 1
fi

unset BASEDIR
onlyinfo=0
while [ '1' -eq '1' ]
do
    case "$1" in
	"--help")
	    echo "help"
	    exit 0
	    ;;
	"-u")
	    onlyinfo=1
	    shift
	    echo "only removing info"
	    ;;
	"-b")
	    BASEDIR="$2"
	    shift 2	    
	    ;;
	*)
	    break
	    ;;
    esac
done

PPWD=`pwd`

remove_p1=
remove() {
    if [ ! -f "$BASEDIR/$PKG_INFO/$remove_p1" ]
    then
	echo " ERROR: file $PKG_INFO/$remove_p1 not found"
	return 1
    fi
    basename "$remove_p1" .xz
    if [ $? -ne 0 ]
    then
	echo " ERROR: wrong filelist file"
	return 1
    fi

    if [ $onlyinfo -ne 1 ]
    then
	if [ -d "$tmp" ]
	then
	    rm -r "$tmp"
	fi

	tmp=`bash $AIP_DIR/_aipb_gettempdir`
	
	cat "$BASEDIR/$PKG_INFO/$remove_p1" | xz -d | sort -r > "$tmp/list_1"

	loca="`wc -l \"$tmp/list_1\" | bash \"$AIP_DIR/_aipb_slashescape\" | sed -e 's/\ .*//'`"
	if [ -z "$loca" ]
	then
	    echo "error on $remove_p1"
	    continue
	fi
	
	for (( iii=1 ; iii != loca+1 ; iii++ ))
	do
	    filedirname="`cat \"$tmp/list_1\" | sed -e "$iii{p};d"`"
	    filename_tr="$BASEDIR$filedirname"
	    if [ -n "$filename_tr" ]
	    then
		if [ ! -d "$filename_tr" ]
		then
		    rm -v "$filename_tr"
		    dirname_tr="`dirname \"$filename_tr\"`"
		    rmdir -v "$dirname_tr"
		else
		    rmdir -v "$filename_tr"
		fi
	    fi
	done
	
	rm -r "$tmp"	
	unset tmp
    fi
    
    rm "$BASEDIR/$PKG_INFO/buildlogs/$remove_p1"
    rm "$BASEDIR/$PKG_INFO/sums/$remove_p1"
    rm "$BASEDIR/$PKG_INFO/$remove_p1"

    return 0
}

. "$AIP_DIR/_aipb_init"

cd "$BASEDIR/$PKG_INFO"
# if [ "$BASEDIR" = '/' ]
# then
#     "$BASEDIR"=
# fi
pwd
set -f
echo "searching for: $@"
b_filelist=
for b_i in $@
do
    b_filelist="$b_filelist `find . -maxdepth 1 -type f -name \"$b_i\" -printf \" %f\" ` "
done

set +f
echo -e "found:\n$b_filelist"

for b_i in $b_filelist
do
    remove_p1="$b_i"
    remove
done

err=$?

if [ -z "$BASEDIR" ]
then
    echo "ldconfig"
    ldconfig
    echo "update-mime-database /usr/share/mime"
    update-mime-database /usr/share/mime
    echo "gdk-pixbuf-query-loaders > /etc/gtk-2.0/gdk-pixbuf.loaders"
    gdk-pixbuf-query-loaders > /etc/gtk-2.0/gdk-pixbuf.loaders
    echo "pango-querymodules > /etc/pango/pango.modules"
    pango-querymodules > /etc/pango/pango.modules
fi
echo "sync"
sync

exit $err