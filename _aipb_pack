#!/bin/bash


if [ ! -d "$AIP_DIR" ]
then
    echo " SORRY: please, install aipsetup (if not yet),"
    echo "        and run 'remove' from main program (aipsetup)"
    echo " ERROR: AIP_DIR not set"
    exit 1
fi

if [ ! -f "$AIP_DIR/_aipb_pksums" ]
then
    echo " ERROR: can't find [$AIP_DIR/_aipb_pksums]"
    exit 1
fi

. "$AIP_DIR/_aipb_init"

echo 'changing owner'
chown -R root.root *
echo 'changing rules'
chmod -R 755 *

PPWD=`pwd`
PKGNAME=`basename $PPWD`

FILEDIR=./var/log/packages
FILELIST="$FILEDIR/$PKGNAME"

echo "Creating package: $PKGNAME..."
echo "  creating installation file list"
mkdir -p "$FILEDIR" > /dev/null 2> /dev/null
rm  "$FILEDIR"/* > /dev/null 2> /dev/null

touch "$FILELIST"
find ./ '(' '(' -type f -o -type l ')' -a '(' ! -regex '.*/var/log/packages.*' ')' ')' | sed -e "s/^\.//g" >> "$FILELIST"
 
cat "$FILELIST" | sort > "$FILELIST"1
cat "$FILELIST"1 > "$FILELIST"
rm "$FILELIST"1

bzip2 -9 "$FILELIST"

bash "$AIP_DIR/_aipb_pksums"


mkdir ../pack > /dev/null 2> /dev/null

echo "   tarring..."
tar --exclude _aipb_pack -c * | bzip2 -9 | sed -e 's/\.\.\/pack\//\.\//'  > "../pack/$PKGNAME.tar.bz2"
echo "     md5..."
md5sum -b "../pack/$PKGNAME.tar.bz2" | sed -e 's/\.\.\/pack\//\.\//'  > "../pack/$PKGNAME.tar.bz2.md5"
echo "     sha512sum..."
sha512sum -b "../pack/$PKGNAME.tar.bz2" | sed -e 's/\.\.\/pack\//\.\//'  > "../pack/$PKGNAME.tar.bz2.sha512"

echo "done"
exit 0